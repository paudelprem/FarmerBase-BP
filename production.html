<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Production тАУ FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:system-ui;background:#f5f7fa}
.container{max-width:980px;margin:auto;padding:16px}
.card{background:#fff;padding:16px;border-radius:8px;margin-bottom:12px}
h2{margin:0 0 8px;color:#1b5e20}
h3{margin:8px 0;color:#2e7d32}
.row{display:flex;gap:8px;flex-wrap:wrap}
input,select,textarea{padding:8px;border:1px solid #ccc;border-radius:6px}
button{padding:8px 12px;border:none;border-radius:6px;background:#1b5e20;color:#fff;cursor:pointer}
button.secondary{background:#607d8b}
button.ghost{background:#e8f5e9;color:#1b5e20}
small{color:#666}

.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border:1px solid #ddd;padding:8px;text-align:right}
.table th{text-align:left;background:#e8f5e9}

.type-box{border:1px solid #ddd;border-radius:8px;margin-top:10px}
.type-head{display:flex;align-items:center;justify-content:space-between;padding:10px;background:#f1f8f4}
.type-head b{color:#1b5e20}
.type-actions button{margin-left:6px}
.type-body{display:none;padding:10px}
.type-body.open{display:block}

.prod-row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 2fr auto;gap:6px;margin-top:6px}
.prod-row input,.prod-row select{width:100%}

.summary{display:flex;gap:12px;flex-wrap:wrap}
.summary .chip{background:#e8f5e9;border-radius:999px;padding:6px 10px}

.search{margin-left:auto}

/* ===== GLOBAL NAV ===== */
.g-header{
  display:flex;align-items:center;gap:10px;
  padding:10px;background:#1b5e20;color:#fff
}
.g-header button{background:none;border:none;color:#fff;font-size:18px}
.g-title{flex:1;text-align:center}

.g-footer{
  display:flex;justify-content:space-between;
  padding:10px;border-top:1px solid #ccc
}
.g-footer button{
  border-radius:20px
}
.g-header button:disabled,.g-footer button:disabled{opacity:.4;cursor:not-allowed}
</style>
</head>

<body>

<!-- ===== GLOBAL HEADER ===== -->
<header class="g-header">
  <button id="prevTop" onclick="goPrev()">тмЕя╕П</button>
  <div class="g-title">
    <div id="bizHdr"></div>
    <small id="projHdr"></small>
  </div>
  <button id="nextTop" onclick="goNext()">тЮбя╕П</button>
</header>

<div class="container">

<!-- ===== PAGE TITLE ===== -->
<div class="card">
  <h2>рдЙрддреНрдкрд╛рджрди (Production)</h2>
  <div class="row">
    <small>рдЙрддреНрдкрд╛рджрдирдХреЛ рдкреНрд░рдХрд╛рд░ рдердкреНрдиреБрд╣реЛрд╕реН, рддреНрдпрд╕рдкрдЫрд┐ рд╡рд╕реНрддреБ/рд╕реЗрд╡рд╛ рд░рд╛рдЦреНрдиреБрд╣реЛрд╕реНред рдзреЗрд░реИ рднрдП collapse рдЧрд░реЗрд░ рдЦреЛрдЬреНрди рд╕рдХрд┐рдиреНрдЫред</small>
    <input class="search" id="q" placeholder="Search productтАж" oninput="render()">
  </div>
</div>

<!-- ===== ADD TYPE ===== -->
<div class="card">
  <h3>рдЙрддреНрдкрд╛рджрдирдХреЛ рдкреНрд░рдХрд╛рд░</h3>
  <div class="row">
    <input id="newType" placeholder="рдЬрд╕реНрддреИ: рдХреГрд╖рд┐ / рдкрд╢реБ / рд╕реЗрд╡рд╛">
    <button onclick="addType()">тЮХ рдкреНрд░рдХрд╛рд░ рдердкреНрдиреБрд╣реЛрд╕реН</button>
  </div>
</div>

<!-- ===== TYPES LIST ===== -->
<div id="types"></div>

<!-- ===== SUMMARY ===== -->
<div class="card">
  <h3>рд╕рдВрдХреНрд╖реЗрдк (Type-wise)</h3>
  <div class="summary" id="summary"></div>
</div>

</div>

<!-- ===== GLOBAL FOOTER ===== -->
<footer class="g-footer">
  <button id="prevBottom" class="secondary" onclick="goPrev()">тмЕя╕П рдЕрдШрд┐рд▓реНрд▓реЛ</button>
  <button id="nextBottom" onclick="goNext()">рдЕрд░реНрдХреЛ тЮбя╕П</button>
</footer>

<script>
/* ================= GLOBAL NAV ================= */
const flow=[
"index.html","short-info.html","existing-status.html",
"business-detail.html","production.html","expenses.html",
"capital-source.html","income.html","profit-loss.html",
"executive-summary.html","cover.html"
];
const cur=location.pathname.split("/").pop();
const idx=flow.indexOf(cur);
function goPrev(){ if(idx>0) location.href=flow[idx-1]; }
function goNext(){ if(idx<flow.length-1) location.href=flow[idx+1]; }
if(idx<=0){prevTop.disabled=prevBottom.disabled=true;}
if(idx>=flow.length-1){nextTop.disabled=nextBottom.disabled=true;}

/* ================= HEADER META ================= */
const meta=JSON.parse(localStorage.getItem("fb_meta")||"{}");
bizHdr.textContent=meta.business||"рд╡реНрдпрд╡рд╕рд╛рдп";
projHdr.textContent=meta.project||"рдкрд░рд┐рдпреЛрдЬрдирд╛";

/* ================= DATA =================
Structure:
types = [
{ id, name, products:[
   { name, unit, qty, note }
]}
]
*/
const KEY="fb_production";
let types=JSON.parse(localStorage.getItem(KEY)||"[]");

/* ================= HELPERS ================= */
const uid=()=>Math.random().toString(36).slice(2,9);
const save=()=>localStorage.setItem(KEY,JSON.stringify(types));

/* ================= TYPE CRUD ================= */
function addType(){
  if(!newType.value) return alert("рдкреНрд░рдХрд╛рд░рдХреЛ рдирд╛рдо рдЪрд╛рд╣рд┐рдиреНрдЫ");
  types.push({id:uid(),name:newType.value,products:[]});
  newType.value="";
  save(); render();
}
function editType(id){
  const t=prompt("рдкреНрд░рдХрд╛рд░ рд╕рдЪреНрдпрд╛рдЙрдиреБрд╣реЛрд╕реН", types.find(x=>x.id===id).name);
  if(t===null) return;
  types.find(x=>x.id===id).name=t;
  save(); render();
}
function delType(id){
  if(!confirm("рдпреЛ рдкреНрд░рдХрд╛рд░ рд░ рднрд┐рддреНрд░рдХрд╛ рд╕рдмреИ рдЙрддреНрдкрд╛рджрди рд╣рдЯрд╛рдЙрдиреЗ?")) return;
  types=types.filter(x=>x.id!==id);
  save(); render();
}
function toggleType(id){
  const el=document.getElementById("tb-"+id);
  el.classList.toggle("open");
}

/* ================= PRODUCT CRUD ================= */
function addProd(tid){
  const box=document.getElementById("add-"+tid);
  const p={
    name:box.querySelector(".p-name").value,
    unit:box.querySelector(".p-unit").value,
    qty:+box.querySelector(".p-qty").value||0,
    note:box.querySelector(".p-note").value
  };
  if(!p.name||!p.unit) return alert("рдирд╛рдо рд░ рдЗрдХрд╛рдИ рдЕрдирд┐рд╡рд╛рд░реНрдп");
  types.find(t=>t.id===tid).products.unshift(p); // newest on top
  box.querySelectorAll("input").forEach(i=>i.value="");
  save(); render();
}
function editProd(tid,idxp){
  const t=types.find(t=>t.id===tid);
  const p=t.products[idxp];
  const n=prompt("рдирд╛рдо",p.name); if(n===null) return;
  const u=prompt("рдЗрдХрд╛рдИ",p.unit); if(u===null) return;
  const q=prompt("рдкрд░рд┐рдорд╛рдг",p.qty); if(q===null) return;
  const no=prompt("рдХреИрдлрд┐рдпрдд",p.note||""); if(no===null) return;
  t.products[idxp]={name:n,unit:u,qty:+q,note:no};
  save(); render();
}
function delProd(tid,idxp){
  if(!confirm("рдЙрддреНрдкрд╛рджрди рд╣рдЯрд╛рдЙрдиреЗ?")) return;
  const t=types.find(t=>t.id===tid);
  t.products.splice(idxp,1);
  save(); render();
}

/* ================= RENDER ================= */
function render(){
  const qv=(q.value||"").toLowerCase();
  const wrap=document.getElementById("types");
  wrap.innerHTML="";
  let summary={};

  types.forEach(t=>{
    const box=document.createElement("div");
    box.className="type-box";
    box.innerHTML=`
      <div class="type-head">
        <b>${t.name}</b>
        <div class="type-actions">
          <button class="ghost" onclick="toggleType('${t.id}')">тд╡я╕П</button>
          <button class="ghost" onclick="editType('${t.id}')">тЬПя╕П</button>
          <button class="ghost" onclick="delType('${t.id}')">ЁЯЧСя╕П</button>
        </div>
      </div>
      <div class="type-body open" id="tb-${t.id}">
        <div class="prod-row" id="add-${t.id}">
          <input class="p-name" placeholder="рд╡рд╕реНрддреБ/рд╕реЗрд╡рд╛">
          <input class="p-unit" placeholder="рдЗрдХрд╛рдИ">
          <input class="p-qty" type="number" placeholder="рдкрд░рд┐рдорд╛рдг">
          <input class="p-note" placeholder="рдХреИрдлрд┐рдпрдд">
          <button onclick="addProd('${t.id}')">тЮХ</button>
        </div>
        <table class="table">
          <thead>
            <tr><th>рд╡рд╕реНрддреБ/рд╕реЗрд╡рд╛</th><th>рдЗрдХрд╛рдИ</th><th>рдкрд░рд┐рдорд╛рдг</th><th>рдХреИрдлрд┐рдпрдд</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>`;
    const tbody=box.querySelector("tbody");

    t.products.forEach((p,i)=>{
      if(qv && !(p.name.toLowerCase().includes(qv)||t.name.toLowerCase().includes(qv))) return;
      summary[t.name]=(summary[t.name]||0)+(+p.qty||0);
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td style="text-align:left">${p.name}</td>
        <td style="text-align:left">${p.unit}</td>
        <td>${p.qty}</td>
        <td style="text-align:left">${p.note||""}</td>
        <td>
          <button class="ghost" onclick="editProd('${t.id}',${i})">тЬПя╕П</button>
          <button class="ghost" onclick="delProd('${t.id}',${i})">ЁЯЧСя╕П</button>
        </td>`;
      tbody.appendChild(tr);
    });

    wrap.appendChild(box);
  });

  // summary
  const sum=document.getElementById("summary");
  sum.innerHTML="";
  const total=Object.values(summary).reduce((a,b)=>a+b,0)||0;
  Object.keys(summary).forEach(k=>{
    const pct=total?((summary[k]/total)*100).toFixed(1):"0";
    const chip=document.createElement("div");
    chip.className="chip";
    chip.textContent=`${k}: ${summary[k]} (${pct}%)`;
    sum.appendChild(chip);
  });
}
render();
</script>

</body>
</html>
