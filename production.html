<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Production тАУ FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ===== BASE ===== */
body{
  margin:0;
  font-family:system-ui, -apple-system, sans-serif;
  background:#f5f7fa;
  color:#222;
}
.container{
  max-width:920px;
  margin:auto;
  padding:20px;
}

/* ===== HEADER ===== */
header{
  background:#1b5e20;
  color:#fff;
  padding:10px 16px;
}
header .title{font-size:18px;font-weight:600}
header .sub{font-size:12px;opacity:.9}

/* ===== CARD ===== */
.card{
  background:#fff;
  padding:20px;
  border-radius:8px;
  margin-bottom:20px;
}
.card h2{margin-top:0;color:#1b5e20}

/* ===== FORM ===== */
label{
  display:block;
  margin-top:10px;
  font-size:14px;
}
input, select, textarea{
  width:100%;
  padding:10px;
  margin-top:4px;
  font-size:14px;
  border-radius:6px;
  border:1px solid #ccc;
}
textarea{resize:vertical}

/* ===== FILTER ===== */
.filter{
  display:flex;
  gap:10px;
  margin-bottom:10px;
}
.filter input, .filter select{flex:1}

/* ===== ITEM ===== */
.prod-item{
  border:1px solid #ddd;
  border-radius:6px;
  margin-bottom:10px;
}
.prod-head{
  padding:10px;
  background:#e8f5e9;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
}
.prod-body{
  padding:10px;
  display:none;
}
.prod-item.open .prod-body{display:block}

/* ===== ACTIONS ===== */
.actions button{
  margin-right:6px;
  border:none;
  padding:4px 10px;
  border-radius:14px;
  font-size:12px;
  cursor:pointer;
}
.edit{background:#607d8b;color:#fff}
.delete{background:#c62828;color:#fff}

/* ===== NAV ===== */
.nav{
  display:flex;
  justify-content:space-between;
  margin-top:20px;
}
.nav button{
  padding:10px 16px;
  border:none;
  border-radius:20px;
  background:#1b5e20;
  color:#fff;
  cursor:pointer;
}
.nav button.secondary{background:#607d8b}
</style>
</head>

<body>

<header>
  <div class="title" id="hdrBiz"></div>
  <div class="sub" id="hdrProj"></div>
</header>

<div class="container">

<!-- ADD FORM -->
<div class="card">
  <h2>рдЙрддреНрдкрд╛рджрди рд╡рд┐рд╡рд░рдг</h2>

  <label>рдЙрддреНрдкрд╛рджрдирдХреЛ рдкреНрд░рдХрд╛рд░</label>
  <input id="pType" placeholder="рдХреГрд╖рд┐ / рдкрд╢реБ / рд╕реЗрд╡рд╛">

  <label>рдЙрддреНрдкрд╛рджрди рд╡рд╕реНрддреБ / рд╕реЗрд╡рд╛</label>
  <input id="pName">

  <label>рдЙрддреНрдкрд╛рджрди рдЗрдХрд╛рдИ</label>
  <input id="pUnit" placeholder="kg / рд▓рд┐рдЯрд░ / рд╡рдЯрд╛">

  <label>рдЙрддреНрдкрд╛рджрди рдкрд░рд┐рдорд╛рдг</label>
  <input id="pQty" type="number">

  <label>рдХреИрдлрд┐рдпрдд</label>
  <textarea id="pNote" rows="2"></textarea>

  <button style="margin-top:12px" onclick="addProduction()">тЮХ рдердкреНрдиреБрд╣реЛрд╕реН</button>
</div>

<!-- FILTER -->
<div class="card">
  <div class="filter">
    <input id="search" placeholder="ЁЯФН рдЦреЛрдЬреНрдиреБрд╣реЛрд╕реН..." oninput="applyFilter()">
    <select id="typeFilter" onchange="applyFilter()">
      <option value="">рд╕рдмреИ рдкреНрд░рдХрд╛рд░</option>
    </select>
  </div>

  <div id="prodList"></div>
</div>

<!-- SUMMARY -->
<div class="card">
  <h3>рдЙрддреНрдкрд╛рджрди рд╕рдВрдХреНрд╖реЗрдк</h3>
  <div id="prodSummary"></div>
</div>

<!-- NAV -->
<div class="nav">
  <button class="secondary" onclick="goBack()">тмЕя╕П Business Detail</button>
  <button onclick="goNext()">Next тЮбя╕П</button>
</div>

</div>

<script>
/* ===== KEYS ===== */
const META_KEY="fb_meta";
const KEY="fb_production";

/* ===== HEADER ===== */
const meta=JSON.parse(localStorage.getItem(META_KEY)||"{}");
hdrBiz.textContent=meta.business||"рд╡реНрдпрд╡рд╕рд╛рдп";
hdrProj.textContent=meta.project||"рдкрд░рд┐рдпреЛрдЬрдирд╛";

/* ===== DATA ===== */
let list=JSON.parse(localStorage.getItem(KEY)||"[]");
let editIndex=null;

/* ===== ADD ===== */
function addProduction(){
  if(!pType.value||!pName.value||!pQty.value){
    alert("рдкреНрд░рдХрд╛рд░, рд╡рд╕реНрддреБ рд░ рдкрд░рд┐рдорд╛рдг рдЕрдирд┐рд╡рд╛рд░реНрдп");
    return;
  }

  const obj={
    type:pType.value,
    name:pName.value,
    unit:pUnit.value,
    qty:+pQty.value,
    note:pNote.value
  };

  if(editIndex===null) list.unshift(obj);
  else{ list[editIndex]=obj; editIndex=null; }

  pType.value=pName.value=pUnit.value=pQty.value=pNote.value="";
  save();
}

/* ===== SAVE ===== */
function save(){
  localStorage.setItem(KEY,JSON.stringify(list));
  render();
}

/* ===== RENDER ===== */
function render(){
  prodList.innerHTML="";
  typeFilter.innerHTML='<option value="">рд╕рдмреИ рдкреНрд░рдХрд╛рд░</option>';
  const types={};

  list.forEach((p,i)=>{
    types[p.type]=true;

    const div=document.createElement("div");
    div.className="prod-item";
    div.dataset.text=(p.type+p.name+p.unit).toLowerCase();
    div.dataset.type=p.type;

    div.innerHTML=`
      <div class="prod-head" onclick="divToggle(this)">
        <b>${p.type}: ${p.name}</b>
        <span>${p.qty} ${p.unit}</span>
      </div>
      <div class="prod-body">
        <p><b>рдХреИрдлрд┐рдпрдд:</b> ${p.note||"-"}</p>
        <div class="actions">
          <button class="edit" onclick="edit(${i})">тЬПя╕П рд╕рдЪреНрдпрд╛рдЙрдиреЗ</button>
          <button class="delete" onclick="del(${i})">ЁЯЧС рд╣рдЯрд╛рдЙрдиреЗ</button>
        </div>
      </div>
    `;
    prodList.appendChild(div);
  });

  Object.keys(types).forEach(t=>{
    const o=document.createElement("option");
    o.value=t; o.textContent=t;
    typeFilter.appendChild(o);
  });

  renderSummary();
}

/* ===== TOGGLE ===== */
function divToggle(el){
  el.parentElement.classList.toggle("open");
}

/* ===== FILTER ===== */
function applyFilter(){
  const q=search.value.toLowerCase();
  const t=typeFilter.value;

  document.querySelectorAll(".prod-item").forEach(d=>{
    const okText=d.dataset.text.includes(q);
    const okType=!t||d.dataset.type===t;
    d.style.display=(okText&&okType)?"block":"none";
  });
}

/* ===== EDIT / DELETE ===== */
function edit(i){
  const p=list[i];
  pType.value=p.type;
  pName.value=p.name;
  pUnit.value=p.unit;
  pQty.value=p.qty;
  pNote.value=p.note;
  editIndex=i;
}
function del(i){
  if(confirm("рд╣рдЯрд╛рдЙрдиреЗ?")){
    list.splice(i,1);
    save();
  }
}

/* ===== SUMMARY ===== */
function renderSummary(){
  const byType={}, total=list.reduce((s,p)=>s+p.qty,0);

  list.forEach(p=>{
    byType[p.type]=(byType[p.type]||0)+p.qty;
  });

  let html="";
  Object.entries(byType).forEach(([k,v])=>{
    const pct=total?((v/total)*100).toFixed(1):0;
    html+=`${k}: ${v} (${pct}%)<br>`;
  });

  prodSummary.innerHTML=html||"тАФ";
}

/* ===== NAV ===== */
function goBack(){location.href="business-detail.html"}
function goNext(){location.href="expenses.html"}

render();
</script>

</body>
</html>
