<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Production</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:system-ui;background:#f5f7fa}
header{
  background:#1b5e20;color:#fff;
  padding:10px 16px;
  display:flex;justify-content:space-between;align-items:center
}
footer{
  position:fixed;bottom:0;left:0;right:0;
  background:#f1f8f4;border-top:1px solid #ccc;
  padding:8px 12px;
  display:flex;justify-content:space-between
}
.container{
  max-width:1100px;margin:auto;padding:16px;
  padding-bottom:80px
}
.card{
  background:#fff;padding:16px;border-radius:8px;
  margin-bottom:16px
}
h2{margin:0 0 8px;color:#1b5e20}
.small{font-size:14px;color:#555}

input{
  padding:8px;border:1px solid #ccc;border-radius:6px
}
button{
  padding:6px 14px;border:none;border-radius:6px;
  background:#1b5e20;color:#fff;cursor:pointer
}
button.ghost{background:#e8f5e9;color:#1b5e20}
button.danger{background:#c62828}

.category{
  border:1px solid #ddd;border-radius:6px;
  margin-top:10px
}
.cat-head{
  background:#f1f8f4;
  padding:10px;
  display:flex;justify-content:space-between;align-items:center;
  cursor:pointer
}
.cat-body{padding:10px}

.item{
  display:grid;
  grid-template-columns:2fr 1fr 1fr 1fr auto;
  gap:6px;align-items:center;
  border-bottom:1px dashed #ddd;padding:6px 0
}
.summary{
  margin-top:8px;
  background:#fafafa;padding:8px;border-radius:6px;
  font-size:13px
}
</style>
</head>

<body>

<!-- HEADER -->
<header>
  <div><b>FarmerBase BP Engine</b></div>
  <div id="hdrName"></div>
</header>

<div class="container">

<div class="card">
  <h2>ЁЯУж рдЙрддреНрдкрд╛рджрди рд╡рд┐рд╡рд░рдг (Production)</h2>
  <p class="small">
    рдпрд╕ рдЦрдгреНрдбрдорд╛ рдЙрддреНрдкрд╛рджрдирдХреЛ рдкреНрд░рдХрд╛рд░, рд╡рд╕реНрддреБ/рд╕реЗрд╡рд╛,
    рдЙрддреНрдкрд╛рджрди рдЗрдХрд╛рдИ, рдкрд░рд┐рдорд╛рдг рддрдерд╛ рдХреИрдлрд┐рдпрдд
    рд╡рд┐рд╡рд░рдг рдкреНрд░рд╡рд┐рд╖реНрдЯ рдЧрд░рд┐рдиреНрдЫред
    рдпрд╣реА рд╡рд┐рд╡рд░рдг рдЦрд░реНрдЪ рд░ рдЖрдореНрджрд╛рдиреАрд╕рдБрдЧ рдЬреЛрдбрд┐рдиреНрдЫред
  </p>
</div>

<!-- ADD CATEGORY -->
<div class="card">
  <h2>тЮХ рдЙрддреНрдкрд╛рджрдирдХреЛ рдкреНрд░рдХрд╛рд░ рдердкреНрдиреБрд╣реЛрд╕реН</h2>
  <input id="catInput" placeholder="рдЙрддреНрдкрд╛рджрди рдкреНрд░рдХрд╛рд░ (рдЬрд╕реНрддреИ: рдкрд╢реБрдкрд╛рд▓рди)">
  <button type="button" onclick="addCategory()">рдердкреНрдиреБрд╣реЛрд╕реН</button>
</div>

<!-- CATEGORY LIST -->
<div id="catList"></div>

</div>

<!-- FOOTER NAV -->
<footer>
  <button type="button" onclick="goPrev()">тмЕя╕П</button>
  <button type="button" onclick="goNext()">тЮбя╕П</button>
</footer>

<script>
/* ===== IDENTITY ===== */
const identity = JSON.parse(localStorage.getItem("fb_identity"));
if(!identity){
  alert("рдкрд╣рд┐рд▓реЗ Login рдЧрд░реНрдиреБрд╣реЛрд╕реН");
  location.href="login.html";
}
hdrName.textContent =
  identity.projectName || identity.businessName || "";

/* ===== DATA ===== */
const KEY="fb_production";
let data = JSON.parse(localStorage.getItem(KEY)) || [];

function save(){
  localStorage.setItem(KEY, JSON.stringify(data));
}

/* ===== CATEGORY ===== */
function addCategory(){
  const name = catInput.value.trim();
  if(!name){
    alert("рдЙрддреНрдкрд╛рджрди рдкреНрд░рдХрд╛рд░ рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН");
    return;
  }
  data.unshift({name, open:true, products:[]});
  catInput.value="";
  save();render();
}
function editCategory(i){
  const n = prompt("рдирдпрд╛рдБ рдирд╛рдо:", data[i].name);
  if(n){
    data[i].name=n;save();render();
  }
}
function delCategory(i){
  if(!confirm("рд╣рдЯрд╛рдЙрдиреЗ?")) return;
  data.splice(i,1);save();render();
}
function toggle(i){
  data[i].open = !data[i].open;
  save();render();
}

/* ===== PRODUCT ===== */
function addProduct(i){
  const box = document.getElementById("add-"+i);
  const p={
    name: box.querySelector(".p-name").value,
    unit: box.querySelector(".p-unit").value,
    qty: +box.querySelector(".p-qty").value||0,
    note: box.querySelector(".p-note").value
  };
  if(!p.name || !p.unit){
    alert("рд╡рд╕реНрддреБ/рд╕реЗрд╡рд╛ рд░ рдЗрдХрд╛рдИ рдЕрдирд┐рд╡рд╛рд░реНрдп");
    return;
  }
  data[i].products.unshift(p);
  box.querySelectorAll("input").forEach(x=>x.value="");
  save();render();
}
function editProduct(i,j){
  const p = data[i].products[j];
  p.name = prompt("рдирд╛рдо:",p.name)||p.name;
  p.unit = prompt("рдЗрдХрд╛рдИ:",p.unit)||p.unit;
  p.qty  = +prompt("рдкрд░рд┐рдорд╛рдг:",p.qty)||p.qty;
  p.note = prompt("рдХреИрдлрд┐рдпрдд:",p.note)||p.note;
  save();render();
}
function delProduct(i,j){
  if(!confirm("рд╣рдЯрд╛рдЙрдиреЗ?")) return;
  data[i].products.splice(j,1);
  save();render();
}

/* ===== SUMMARY ===== */
function totalQty(cat){
  let t=0;
  cat.products.forEach(p=>t+=p.qty);
  return t;
}

/* ===== RENDER ===== */
function render(){
  catList.innerHTML="";
  data.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="category";
    d.innerHTML=`
      <div class="cat-head" onclick="toggle(${i})">
        <b>${c.name}</b>
        <div>
          <button class="ghost" type="button"
            onclick="event.stopPropagation();editCategory(${i})">тЬПя╕П</button>
          <button class="danger" type="button"
            onclick="event.stopPropagation();delCategory(${i})">тЬЦ</button>
        </div>
      </div>

      ${c.open?`
      <div class="cat-body">
        <div class="item" id="add-${i}">
          <input class="p-name" placeholder="рд╡рд╕реНрддреБ/рд╕реЗрд╡рд╛">
          <input class="p-unit" placeholder="рдЗрдХрд╛рдИ">
          <input class="p-qty" type="number" placeholder="рдкрд░рд┐рдорд╛рдг">
          <input class="p-note" placeholder="рдХреИрдлрд┐рдпрдд">
          <button type="button" onclick="addProduct(${i})">тЮХ</button>
        </div>

        ${c.products.map((p,j)=>`
          <div class="item">
            <span>${p.name}</span>
            <span>${p.unit}</span>
            <span>${p.qty}</span>
            <span>${p.note||""}</span>
            <div>
              <button class="ghost" type="button"
                onclick="editProduct(${i},${j})">тЬПя╕П</button>
              <button class="danger" type="button"
                onclick="delProduct(${i},${j})">тЬЦ</button>
            </div>
          </div>
        `).join("")}

        <div class="summary">
          рдХреБрд▓ рдкрд░рд┐рдорд╛рдг: <b>${totalQty(c)}</b>
        </div>
      </div>`:""}
    `;
    catList.appendChild(d);
  });
}
render();

/* ===== NAV ===== */
function goPrev(){ location.href="business-detail.html"; }
function goNext(){ location.href="expenses.html"; }
</script>

</body>
</html>
