<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Auto Proposal | FarmerBase BP Engine</title>

<style>
body{font-family:system-ui;background:#f6f7f9;margin:0}
.wrap{max-width:900px;margin:auto;background:#fff;padding:20px}
h1,h2{color:#1b5e20}
p{line-height:1.7;font-size:14px}
.section{margin-bottom:22px}
.btn{padding:6px 14px;border:1px solid #ccc;border-radius:20px;
     background:#1b5e20;color:#fff;cursor:pointer;margin-right:6px}
.small{font-size:12px;color:#555}
@media print{.btn{display:none}}
</style>
</head>

<body>

<div class="wrap">
  <button class="btn" onclick="setLang('np')">ЁЯЗ│ЁЯЗ╡ рдиреЗрдкрд╛рд▓реА</button>
  <button class="btn" onclick="setLang('en')">ЁЯЗмЁЯЗз English</button>
  <button class="btn" onclick="window.print()">ЁЯЦия╕П Print / PDF</button>

  <h1 id="title"></h1>
  <div id="proposal"></div>
</div>

<script>
/* ========= LOAD DATA ========= */
const B = JSON.parse(localStorage.getItem("fb_businesses")||"{}");
const BID = B.activeId || "b1";
const info = JSON.parse(localStorage.getItem("fb_short_info_"+BID)||"{}");
const prod = JSON.parse(localStorage.getItem("fb_production_items_"+BID)||"[]");
const exp  = JSON.parse(localStorage.getItem("fb_expenses_"+BID)||"{}");
const cap  = JSON.parse(localStorage.getItem("fb_capital_source_"+BID)||"{}");
const inc  = JSON.parse(localStorage.getItem("fb_income_"+BID)||"{}");
const dist = JSON.parse(localStorage.getItem("fb_profit_distribution_"+BID)||"[]");

/* ========= CALC ========= */
let totalExp=0;
[...(exp.current||[]),...(exp.fixed||[])].forEach(e=>{
  totalExp+=(+e.qty||0)*(+e.rate||0);
});
let totalInc=0;
prod.forEach(p=>{
  totalInc+=(+inc[p.name]?.price||0)*(+p.qty||0);
});
let interest=0;
(cap.rows||[]).forEach(r=>{
  if(r.loan){
    interest+=totalExp*((+r.pct||0)/100)*((+r.rate||0)/100);
  }
});
const netProfit=totalInc-totalExp-interest;
const ROI=totalExp?((netProfit/totalExp)*100).toFixed(2):0;

/* ========= LANGUAGE ========= */
let LANG="np";

function setLang(l){
  LANG=l;
  render();
}

/* ========= RENDER ========= */
function render(){
  if(LANG==="np"){
    title.textContent = `рд╡реНрдпрд╡рд╕рд╛рдпрд┐рдХ рдкреНрд░рд╕реНрддрд╛рд╡ (${info.projectName||"рдкрд░рд┐рдпреЛрдЬрдирд╛"})`;
    proposal.innerHTML = `
    <div class="section">
      <h2>рез. рдкрд░рд┐рдЪрдп</h2>
      <p>${info.businessName} рджреНрд╡рд╛рд░рд╛ рдкреНрд░рд╕реНрддрд╛рд╡рд┐рдд <b>${info.projectName}</b> рдкрд░рд┐рдпреЛрдЬрдирд╛
      рдЖрд░реНрдерд┐рдХ рд░реВрдкрдорд╛ рджрд┐рдЧреЛ рд╡реНрдпрд╡рд╕рд╛рдп рд╡рд┐рдХрд╛рд╕рдХрд╛ рд▓рд╛рдЧрд┐ рддрдпрд╛рд░ рдЧрд░рд┐рдПрдХреЛ рд╣реЛред</p>
    </div>

    <div class="section">
      <h2>реи. рдЙрджреНрджреЗрд╢реНрдп</h2>
      <p>рдЖрдореНрджрд╛рдиреА рд╡реГрджреНрдзрд┐, рд░реЛрдЬрдЧрд╛рд░реА рд╕рд┐рд░реНрдЬрдирд╛ рд░ рджреАрд░реНрдШрдХрд╛рд▓реАрди рд╕реНрдерд╛рдпрд┐рддреНрд╡ рд╣рд╛рд╕рд┐рд▓ рдЧрд░реНрдиреБред</p>
    </div>

    <div class="section">
      <h2>рей. рдЙрддреНрдкрд╛рджрди рд╡рд┐рд╡рд░рдг</h2>
      <ul>${prod.map(p=>`<li>${p.name} тАУ ${p.qty} ${p.unit}</li>`).join("")}</ul>
    </div>

    <div class="section">
      <h2>рек. рдЦрд░реНрдЪ рд╕рдВрд░рдЪрдирд╛</h2>
      <p>рдХреБрд▓ рд▓рд╛рдЧрдд рд░реБ ${totalExp.toLocaleString()} рдЕрдиреБрдорд╛рди рдЧрд░рд┐рдПрдХреЛ рдЫред</p>
    </div>

    <div class="section">
      <h2>рел. рдкреБрдБрдЬреА рд╕рдВрд░рдЪрдирд╛</h2>
      <ul>${(cap.rows||[]).map(r=>`<li>${r.name} тАУ ${r.pct}%</li>`).join("")}</ul>
    </div>

    <div class="section">
      <h2>рем. рдЖрдореНрджрд╛рдиреА рд░ рдирд╛рдлрд╛</h2>
      <p>рд╡рд╛рд░реНрд╖рд┐рдХ рдЖрдореНрджрд╛рдиреА рд░реБ ${totalInc.toLocaleString()} рд░
      рд╢реБрджреНрдз рдирд╛рдлрд╛ рд░реБ ${netProfit.toLocaleString()} рд░рд╣рдиреЗ рдЕрдиреБрдорд╛рди рдЫред</p>
    </div>

    <div class="section">
      <h2>рен. ROI</h2>
      <p>рдкрд░рд┐рдпреЛрдЬрдирд╛рдХреЛ ROI ${ROI}% рд░рд╣реЗрдХреЛ рдЫред</p>
    </div>

    <div class="section">
      <h2>рео. рдирд╛рдлрд╛ рд╡рд┐рддрд░рдг</h2>
      <ul>${dist.map(d=>`<li>${d.title} тАУ ${d.pct}%</li>`).join("")}</ul>
    </div>

    <div class="section">
      <h2>реп. рдирд┐рд╖реНрдХрд░реНрд╖</h2>
      <p>рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрдирдХрд╛ рд▓рд╛рдЧрд┐ рдЙрдкрдпреБрдХреНрдд рд░ рд╕рд┐рдлрд╛рд░рд┐рд╕рдпреЛрдЧреНрдп рджреЗрдЦрд┐рдиреНрдЫред</p>
    </div>`;
  }

  /* ---------- ENGLISH ---------- */
  else{
    title.textContent = `Business Proposal (${info.projectName||"Project"})`;
    proposal.innerHTML = `
    <div class="section">
      <h2>1. Introduction</h2>
      <p>The proposed <b>${info.projectName}</b> by ${info.businessName}
      aims to establish a financially sustainable and market-oriented business.</p>
    </div>

    <div class="section">
      <h2>2. Objectives</h2>
      <p>The project focuses on income generation, employment creation,
      and long-term economic sustainability.</p>
    </div>

    <div class="section">
      <h2>3. Production Details</h2>
      <ul>${prod.map(p=>`<li>${p.name} тАУ ${p.qty} ${p.unit}</li>`).join("")}</ul>
    </div>

    <div class="section">
      <h2>4. Cost Structure</h2>
      <p>The total estimated project cost is NPR ${totalExp.toLocaleString()}.</p>
    </div>

    <div class="section">
      <h2>5. Capital Structure</h2>
      <ul>${(cap.rows||[]).map(r=>`<li>${r.name} тАУ ${r.pct}%</li>`).join("")}</ul>
    </div>

    <div class="section">
      <h2>6. Income & Profit Analysis</h2>
      <p>The projected annual revenue is NPR ${totalInc.toLocaleString()},
      with an estimated net profit of NPR ${netProfit.toLocaleString()}.</p>
    </div>

    <div class="section">
      <h2>7. ROI</h2>
      <p>The project yields an estimated Return on Investment (ROI) of ${ROI}%.</p>
    </div>

    <div class="section">
      <h2>8. Profit Allocation</h2>
      <ul>${dist.map(d=>`<li>${d.title} тАУ ${d.pct}%</li>`).join("")}</ul>
    </div>

    <div class="section">
      <h2>9. Conclusion</h2>
      <p>Based on the above analysis, the project is financially viable
      and recommended for implementation.</p>
    </div>`;
  }
}

/* INIT */
render();
</script>

</body>
</html>
