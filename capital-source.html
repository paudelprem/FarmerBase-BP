<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Capital Source | FarmerBase BP Engine</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#f6f7f9;color:#222}
:root{--w:980px;--g:#1b5e20;--b:#ddd}

/* HEADER */
.header{position:sticky;top:0;z-index:100;background:#fff;border-bottom:1px solid var(--b)}
.header-inner{max-width:var(--w);margin:auto;padding:10px 14px}
.header h1{margin:0;font-size:16px}
.header .sub{font-size:12px;color:#555}

/* NAV */
.nav-bar{max-width:var(--w);margin:8px auto;padding:0 14px;display:flex;justify-content:space-between}
.nav-btn{text-decoration:none;font-size:13px;padding:6px 14px;border-radius:20px;border:1px solid #ccc;background:#fafafa;color:#222}
.nav-btn.primary{background:var(--g);color:#fff;border-color:var(--g)}
.top-nav{position:sticky;top:56px}
.bottom-nav{position:sticky;bottom:0}

/* MAIN */
.main{max-width:var(--w);margin:10px auto 20px;padding:0 14px}
.card{background:#fff;border:1px solid var(--b);border-radius:8px;margin-bottom:16px}
.card h3{margin:0;padding:10px 12px;background:#f3f5f7;border-bottom:1px solid var(--b);font-size:14px}
.card .body{padding:12px;font-size:13px}

input,textarea{
  width:100%;padding:6px;border:1px solid #ccc;border-radius:6px;font-size:13px
}
textarea{resize:vertical}

.btn{font-size:12px;padding:4px 10px;margin:4px;cursor:pointer}
.btn.primary{color:#1b5e20;font-weight:600}
.btn.danger{color:#b71c1c}

.small{font-size:11px;color:#555}
.warn{color:#b71c1c;font-size:12px;margin-top:6px}

/* TABLE */
table{width:100%;border-collapse:collapse;margin-top:6px}
th,td{border:1px solid #ddd;padding:6px;font-size:12px;text-align:center}
th{background:#f3f5f7}

@media print{.nav-bar{display:none}}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <h1 id="pageTitle">‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ</h1>
    <div class="sub" id="pageSub">‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø / ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ</div>
  </div>
</div>

<!-- NAV -->
<div class="nav-bar top-nav">
  <a href="expenses.html" class="nav-btn">‚¨ÖÔ∏è ‡§ñ‡§∞‡•ç‡§ö</a>
  <a href="income.html" class="nav-btn primary">‚û°Ô∏è ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</a>
</div>

<div class="main">

<!-- CAPITAL SUMMARY -->
<div class="card">
  <h3>üìå ‡§ï‡•Å‡§≤ ‡§™‡•Å‡§Å‡§ú‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£ (Auto)</h3>
  <div class="body" id="capitalSummary"></div>
</div>

<!-- CAPITAL SOURCE -->
<div class="card">
  <h3>üè¶ ‡§™‡•Å‡§Å‡§ú‡•Ä‡§ï‡•ã ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§µ‡§ø‡§§‡§∞‡§£</h3>
  <div class="body">

    <button class="btn primary" id="addRowBtn">‚ûï ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>

    <table>
      <thead>
        <tr>
          <th>‡§∏‡•ç‡§∞‡•ã‡§§</th>
          <th>%</th>
          <th>‡§∞‡§ï‡§Æ</th>
          <th>‡§ã‡§£?</th>
          <th>‡§¨‡•ç‡§Ø‡§æ‡§ú %</th>
          <th>‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§¨‡•ç‡§Ø‡§æ‡§ú</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="sourceTable"></tbody>
    </table>

    <div id="percentWarn" class="warn"></div>
  </div>
</div>

<!-- NARRATION -->
<div class="card">
  <h3>üìù ‡§™‡•Å‡§Å‡§ú‡•Ä ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§µ‡§ø‡§µ‡§∞‡§£</h3>
  <div class="body">
    <textarea id="note" rows="4"
      placeholder="‡§â‡§¶‡§æ‡§π‡§∞‡§£: ‡§Ø‡•ã ‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∏‡•ç‡§µ‡§≤‡§ó‡§æ‡§®‡•Ä, ‡§¨‡•à‡§Ç‡§ï ‡§ã‡§£ ‡§§‡§•‡§æ ‡§Ö‡§®‡•Å‡§¶‡§æ‡§®‡§ï‡•ã ‡§Æ‡§ø‡§∂‡•ç‡§∞‡§ø‡§§ ‡§™‡•Å‡§Å‡§ú‡•Ä ‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ‡§Æ‡§æ ‡§∏‡§û‡•ç‡§ö‡§æ‡§≤‡§® ‡§ó‡§∞‡§ø‡§®‡•á‡§õ..."></textarea>
  </div>
</div>

</div>

<!-- NAV -->
<div class="nav-bar bottom-nav">
  <a href="expenses.html" class="nav-btn">‚¨ÖÔ∏è ‡§ñ‡§∞‡•ç‡§ö</a>
  <a href="income.html" class="nav-btn primary">‚û°Ô∏è ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</a>
</div>

<script>
/* ========= IDENTITY ========= */
const B = JSON.parse(localStorage.getItem("fb_businesses")||"{}");
const BID = B.activeId || "b1";
const info = JSON.parse(localStorage.getItem("fb_short_info_"+BID)||"{}");
pageTitle.textContent = info.projectName || "‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ";
pageSub.textContent   = info.businessName || "‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø";

/* ========= EXPENSE TOTAL ========= */
const e = JSON.parse(localStorage.getItem("fb_expenses_"+BID)||"{}");
let current = 0, fixed = 0;
(e.current||[]).forEach(x=>current+=(+x.qty||0)*(+x.rate||0));
(e.fixed||[]).forEach(x=>fixed+=(+x.qty||0)*(+x.rate||0));
const TOTAL = current + fixed;

/* ========= STORAGE ========= */
const KEY = "fb_capital_source_"+BID;
let data = JSON.parse(localStorage.getItem(KEY)||"null");
if(!data){
  data = {
    rows:[
      {name:"‡§∏‡•ç‡§µ‡§≤‡§ó‡§æ‡§®‡•Ä",pct:40,loan:false,rate:0},
      {name:"‡§¨‡•à‡§Ç‡§ï ‡§ã‡§£",pct:40,loan:true,rate:12},
      {name:"‡§Ö‡§®‡•Å‡§¶‡§æ‡§®",pct:20,loan:false,rate:0}
    ],
    note:""
  };
}

/* ========= SAVE ========= */
function save(){
  localStorage.setItem(KEY, JSON.stringify(data));
  render();
}

/* ========= SUMMARY ========= */
function renderSummary(){
  capitalSummary.innerHTML = `
    <div>‡§ï‡•Å‡§≤ ‡§™‡•Å‡§Å‡§ú‡•Ä: <b>‡§∞‡•Å ${TOTAL.toLocaleString()}</b></div>
    <div>‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö: ‡§∞‡•Å ${current.toLocaleString()}</div>
    <div>‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö: ‡§∞‡•Å ${fixed.toLocaleString()}</div>
  `;
}

/* ========= RENDER ========= */
function render(){
  renderSummary();
  sourceTable.innerHTML="";
  let pctSum = 0;

  data.rows.forEach((r,i)=>{
    const amt = TOTAL*((+r.pct||0)/100);
    const interest = r.loan ? amt*((+r.rate||0)/100) : 0;
    pctSum += (+r.pct||0);

    sourceTable.innerHTML += `
      <tr>
        <td><input value="${r.name}"
          oninput="data.rows[${i}].name=this.value;save()"></td>

        <td><input type="number" value="${r.pct}"
          oninput="data.rows[${i}].pct=this.value;save()"></td>

        <td>‡§∞‡•Å ${amt.toLocaleString()}</td>

        <td>
          <input type="checkbox" ${r.loan?"checked":""}
            onchange="data.rows[${i}].loan=this.checked;save()">
        </td>

        <td>
          <input type="number" value="${r.rate}"
            ${r.loan?"":"readonly"}
            oninput="data.rows[${i}].rate=this.value;save()">
        </td>

        <td>‡§∞‡•Å ${interest.toLocaleString()}</td>

        <td>
          <button class="btn danger"
            onclick="data.rows.splice(${i},1);save()">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  });

  percentWarn.textContent =
    pctSum===100 ? "" : "‚ö†Ô∏è ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§µ‡§ø‡§§‡§∞‡§£‡§ï‡•ã ‡§ï‡•Å‡§≤ ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§ 100% ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ";
}

/* ========= ADD ROW (CLICK FIXED) ========= */
document.getElementById("addRowBtn")
  .addEventListener("click", ()=>{
    data.rows.push({name:"",pct:0,loan:false,rate:0});
    save();
  });

/* ========= NOTE ========= */
note.value = data.note || "";
note.addEventListener("blur", ()=>{
  data.note = note.value;
  save();
});

render();
</script>

</body>
</html>
