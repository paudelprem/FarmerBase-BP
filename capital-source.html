<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Capital Source | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:system-ui;background:#f4f6f8;margin:0}
header{background:#2e7d32;color:#fff;padding:10px 16px;font-size:18px}
.container{max-width:1100px;margin:auto;padding:16px;padding-bottom:90px}
.box{background:#fff;border-radius:8px;padding:16px;margin-bottom:20px}
h2{margin-top:0}
input,button{padding:6px;font-size:14px}
button{cursor:pointer}
.green{background:#2e7d32;color:#fff;border:0;border-radius:4px;padding:6px 10px}
.red{color:#c62828;font-weight:600}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid #ddd;padding:6px;text-align:left}
.small{font-size:13px;color:#555}
footer{
  position:fixed;left:0;right:0;bottom:0;
  background:#f1f8f4;border-top:1px solid #ccc;
  padding:8px 12px;display:flex;justify-content:space-between
}
</style>
</head>

<body>
<header>FarmerBase BP Engine ‚Äì Capital Source</header>

<div class="container">

<!-- ===== READ EXPENSE SUMMARY ===== -->
<div class="box" id="needBox"></div>

<!-- ===== ADD SOURCE ===== -->
<div class="box">
  <h2>‡§™‡•Å‡§Å‡§ú‡•Ä‡§ï‡•ã ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</h2>
  <input id="srcName" placeholder="‡§∏‡•ç‡§∞‡•ã‡§§ (‡§∏‡•ç‡§µ‚Äì‡§≤‡§ó‡§æ‡§®‡•Ä / ‡§¨‡•à‡§Ç‡§ï ‡§ã‡§£)">
  <input id="srcPct" type="number" placeholder="%">
  <input id="srcRate" type="number" placeholder="‡§¨‡•ç‡§Ø‡§æ‡§ú‡§¶‡§∞ % (‡§ã‡§£ ‡§≠‡§è)">
  <input id="srcYear" type="number" placeholder="‡§Ö‡§µ‡§ß‡§ø (‡§µ‡§∞‡•ç‡§∑)">
  <br><br>
  <b>‡§Ø‡•ã ‡§™‡•Å‡§Å‡§ú‡•Ä ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§π‡•Å‡§®‡•á ‡§ñ‡§∞‡•ç‡§ö:</b><br>
  <label><input type="checkbox" id="mapRun" checked> ‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö</label>
  &nbsp;&nbsp;
  <label><input type="checkbox" id="mapFix" checked> ‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö</label>
  <br><br>
  <button class="green" onclick="addSource()">+ ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
  <div class="small">‡§®‡•ã‡§ü: % ‡§ï‡•ã ‡§Ü‡§ß‡§æ‡§∞‡§Æ‡§æ ‡§∞‡§ï‡§Æ auto-calculated ‡§π‡•Å‡§®‡•ç‡§õ‡•§</div>
</div>

<!-- ===== SOURCE LIST ===== -->
<div class="box">
  <h2>‡§™‡•Å‡§Å‡§ú‡•Ä ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£</h2>
  <table>
    <thead>
      <tr>
        <th>‡§∏‡•ç‡§∞‡•ã‡§§</th>
        <th>%</th>
        <th>‡§∞‡§ï‡§Æ</th>
        <th>Mapping</th>
        <th>‡§¨‡•ç‡§Ø‡§æ‡§ú</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="srcList"></tbody>
  </table>
</div>

<!-- ===== VALIDATION ===== -->
<div class="box">
  <b>Coverage ‡§ú‡§æ‡§Å‡§ö</b><br>
  <div id="warnRun" class="red"></div>
  <div id="warnFix" class="red"></div>
</div>

<!-- ===== SAVE ===== -->
<div class="box">
  <button class="green" onclick="saveAll()">üíæ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§</button>
  <span class="small">Profit‚ÄìLoss ‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø</span>
</div>

</div>

<!-- ===== FOOTER NAV ===== -->
<footer>
  <button onclick="location.href='expenses.html'">‚¨ÖÔ∏è</button>
  <button onclick="goNext()">‚û°Ô∏è</button>
</footer>

<script>
/* ========= READ EXPENSES (AUTO-SYNC GUARD) ========= */
const exp = JSON.parse(localStorage.getItem("fb_expense_summary"));
if(!exp || !exp.total){
  alert("‡§™‡§π‡§ø‡§≤‡•á Expenses ‡§Æ‡§æ ‡§ñ‡§∞‡•ç‡§ö ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç");
  location.href = "expenses.html";
}
const RUN_NEED = +exp.run;
const FIX_NEED = +exp.fix;
const TOTAL_NEED = +exp.total;

document.getElementById("needBox").innerHTML = `
  <b>‡§™‡•Å‡§Å‡§ú‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</b><br>
  ‡§ï‡•Å‡§≤ ‡§™‡•Å‡§Å‡§ú‡•Ä: <b>${TOTAL_NEED.toFixed(2)}</b><br>
  ‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ: <b>${RUN_NEED.toFixed(2)}</b><br>
  ‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ: <b>${FIX_NEED.toFixed(2)}</b>
`;

/* ========= DATA ========= */
let sources = JSON.parse(localStorage.getItem("fb_capital_source")) || [];

/* ========= ADD SOURCE ========= */
function addSource(){
  const name = srcName.value.trim();
  const pct  = +srcPct.value;
  const rate = +srcRate.value || 0;
  const year = +srcYear.value || 0;
  const mRun = mapRun.checked;
  const mFix = mapFix.checked;

  if(!name || !pct){
    alert("‡§∏‡•ç‡§∞‡•ã‡§§ ‡§∞ % ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø");
    return;
  }
  if(!mRun && !mFix){
    alert("‡§ï‡§Æ‡•ç‡§§‡•Ä‡§Æ‡§æ ‡§è‡§ï ‡§ñ‡§∞‡•ç‡§ö ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç");
    return;
  }

  const amt = TOTAL_NEED * pct / 100;

  sources.push({
    name, pct, amt, rate, year,
    map:{ run:mRun, fix:mFix }
  });

  srcName.value = srcPct.value = srcRate.value = srcYear.value = "";
  mapRun.checked = mapFix.checked = true;

  render();
}

/* ========= CALC COVERAGE ========= */
function calcCoverage(){
  let runAlloc = 0, fixAlloc = 0;
  sources.forEach(s=>{
    if(s.map.run) runAlloc += s.amt;
    if(s.map.fix) fixAlloc += s.amt;
  });
  return { runAlloc, fixAlloc };
}

/* ========= RENDER ========= */
function render(){
  const tbody = document.getElementById("srcList");
  tbody.innerHTML = "";

  sources.forEach((s,i)=>{
    tbody.innerHTML += `
      <tr>
        <td>${s.name}</td>
        <td>${s.pct}%</td>
        <td>${s.amt.toFixed(2)}</td>
        <td>${s.map.run?"‡§ö‡§æ‡§≤‡•Å ":""}${s.map.fix?"‡§∏‡•ç‡§•‡§ø‡§∞":""}</td>
        <td>${s.rate ? s.rate+"%" : "-"}</td>
        <td><button onclick="removeItem(${i})">‚úñ</button></td>
      </tr>
    `;
  });

  const c = calcCoverage();
  warnRun.innerText = c.runAlloc < RUN_NEED
    ? "‚ö†Ô∏è ‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§™‡•Å‡§Å‡§ú‡•Ä ‡§Ö‡§™‡•Å‡§ó"
    : "";
  warnFix.innerText = c.fixAlloc < FIX_NEED
    ? "‚ö†Ô∏è ‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§™‡•Å‡§Å‡§ú‡•Ä ‡§Ö‡§™‡•Å‡§ó"
    : "";
}

/* ========= REMOVE ========= */
function removeItem(i){
  if(confirm("‡§π‡§ü‡§æ‡§â‡§®‡•á?")){
    sources.splice(i,1);
    render();
  }
}

/* ========= SAVE ========= */
function saveAll(){
  const pctSum = sources.reduce((s,x)=>s+x.pct,0);
  if(pctSum !== 100){
    alert("‡§ï‡•Å‡§≤ % 100 ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ");
    return;
  }
  localStorage.setItem("fb_capital_source",JSON.stringify(sources));
  alert("Capital Source ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§≠‡§Ø‡•ã");
}

/* ========= NEXT ========= */
function goNext(){
  const pctSum = sources.reduce((s,x)=>s+x.pct,0);
  if(pctSum !== 100){
    alert("‡§ï‡•Å‡§≤ % 100 ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ");
    return;
  }
  location.href = "income.html";
}

render();
</script>

</body>
</html>
