<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Capital Source | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:system-ui;background:#f5f7fa}
header{background:#1b5e20;color:#fff;padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
header .right{display:flex;align-items:center;gap:8px}
header button{background:transparent;border:1px solid #c8e6c9;color:#fff;border-radius:4px;padding:2px 6px;cursor:pointer}
footer{position:fixed;bottom:0;left:0;right:0;background:#f1f8f4;border-top:1px solid #ccc;padding:8px 12px;display:flex;justify-content:space-between}
.container{max-width:1100px;margin:auto;padding:16px;padding-bottom:90px}
.card{background:#fff;padding:16px;border-radius:8px;margin-bottom:16px}
h2{margin:0 0 8px;color:#1b5e20}
.small{font-size:14px;color:#555}
input,textarea{padding:8px;border:1px solid #ccc;border-radius:6px}
button{padding:6px 14px;border:none;border-radius:6px;background:#1b5e20;color:#fff;cursor:pointer}
button.ghost{background:#e8f5e9;color:#1b5e20}
button.danger{background:#c62828}
.item{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr auto;gap:6px;align-items:center;border-bottom:1px dashed #ddd;padding:6px 0}
.summary{background:#fafafa;padding:12px;border-radius:6px;font-size:14px}
.warn{color:#c62828;font-weight:600}
</style>
</head>

<body>
<header>
  <div><b>FarmerBase BP Engine</b></div>
  <div class="right">
    <span id="hdrName"></span>
    <button onclick="location.href='login.html'">‚úèÔ∏è</button>
  </div>
</header>

<div class="container">

  <div class="card summary" id="totalBox"></div>

  <div class="card">
    <h2>‚ûï ‡§™‡•Å‡§Å‡§ú‡•Ä‡§ï‡•ã ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</h2>
    <div class="item">
      <input id="sName" placeholder="‡§∏‡•ç‡§∞‡•ã‡§§ (‡§ú‡§∏‡•ç‡§§‡•à: ‡§∏‡•ç‡§µ‚Äì‡§≤‡§ó‡§æ‡§®‡•Ä / ‡§¨‡•à‡§Ç‡§ï ‡§ã‡§£)">
      <input id="sAmt" type="number" placeholder="‡§∞‡§ï‡§Æ">
      <input id="sPct" type="number" placeholder="%">
      <input id="sRate" type="number" placeholder="‡§¨‡•ç‡§Ø‡§æ‡§ú‡§¶‡§∞ %">
      <input id="sYear" type="number" placeholder="‡§Ö‡§µ‡§ß‡§ø (‡§µ‡§∞‡•ç‡§∑)">
      <button onclick="add()">‚ûï</button>
    </div>
    <div class="small">‡§®‡•ã‡§ü: ‡§ã‡§£ ‡§®‡§≠‡§è ‡§¨‡•ç‡§Ø‡§æ‡§ú‡§¶‡§∞/‡§Ö‡§µ‡§ß‡§ø ‡§ñ‡§æ‡§≤‡•Ä ‡§∞‡§æ‡§ñ‡•ç‡§® ‡§∏‡§ï‡•ç‡§®‡•Å‡§π‡•Å‡§®‡•ç‡§õ‡•§</div>
  </div>

  <div class="card" id="list"></div>

  <div class="card">
    <h2>üßæ ‡§™‡•Å‡§Å‡§ú‡•Ä ‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ (Narration)</h2>
    <textarea id="narration" rows="4" placeholder="‡§™‡•Å‡§Å‡§ú‡•Ä ‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ ‡§ï‡§ø‡§® ‡§Ø‡§∏‡•ç‡§§‡•ã ‡§¨‡§®‡§æ‡§á‡§è‡§ï‡•ã ‡§π‡•ã..."></textarea><br><br>
    <button class="ghost" onclick="autoNarrate()">Auto Draft</button>
    <button onclick="saveNarration()">üíæ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§</button>
  </div>

</div>

<footer>
  <button onclick="location.href='expenses.html'">‚¨ÖÔ∏è</button>
  <button onclick="goNext()">‚û°Ô∏è</button>
</footer>

<script>
/* ===== Identity ===== */
const idRaw = localStorage.getItem("fb_identity");
if(idRaw){
  const id = JSON.parse(idRaw);
  hdrName.textContent = id.projectName || id.businessName || "";
}

/* ===== Total from Expenses ===== */
const exp = JSON.parse(localStorage.getItem("fb_expense_summary")||"{}");
const TOTAL = +exp.total || 0;

/* ===== Data ===== */
const KEY="fb_capital_source";
let data = JSON.parse(localStorage.getItem(KEY)) || [];
const save=()=>localStorage.setItem(KEY, JSON.stringify(data));

/* ===== Render debounce (PERF) ===== */
let raf=null;
function safeRender(){
  if(raf) cancelAnimationFrame(raf);
  raf=requestAnimationFrame(render);
}

/* ===== Add ===== */
function add(){
  const it={
    name:sName.value.trim(),
    amt:+sAmt.value||0,
    pct:+sPct.value||0,
    rate:+sRate.value||0,
    year:+sYear.value||0
  };
  if(!it.name || !it.amt || !it.pct){
    alert("‡§∏‡•ç‡§∞‡•ã‡§§, ‡§∞‡§ï‡§Æ ‡§∞ % ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø");
    return;
  }
  data.push(it);
  sName.value=sAmt.value=sPct.value=sRate.value=sYear.value="";
  save(); safeRender();
}

/* ===== Edit / Delete ===== */
function edit(i){
  const it=data[i];
  it.name=prompt("‡§∏‡•ç‡§∞‡•ã‡§§:",it.name)||it.name;
  it.amt=+prompt("‡§∞‡§ï‡§Æ:",it.amt)||it.amt;
  it.pct=+prompt("%:",it.pct)||it.pct;
  it.rate=+prompt("‡§¨‡•ç‡§Ø‡§æ‡§ú‡§¶‡§∞:",it.rate)||it.rate;
  it.year=+prompt("‡§Ö‡§µ‡§ß‡§ø (‡§µ‡§∞‡•ç‡§∑):",it.year)||it.year;
  save(); safeRender();
}
function del(i){
  if(confirm("‡§π‡§ü‡§æ‡§â‡§®‡•á?")){ data.splice(i,1); save(); safeRender(); }
}

/* ===== Render ===== */
function render(){
  let sumAmt=0, sumPct=0;
  list.innerHTML="";
  data.forEach((it,i)=>{
    sumAmt+=it.amt; sumPct+=it.pct;
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`
      <span>${it.name}</span>
      <span>${it.amt}</span>
      <span>${it.pct}%</span>
      <span>${it.rate||"-"}</span>
      <span>${it.year||"-"}</span>
      <div>
        <button class="ghost" onclick="edit(${i})">‚úèÔ∏è</button>
        <button class="danger" onclick="del(${i})">‚úñ</button>
      </div>`;
    list.appendChild(d);
  });

  totalBox.innerHTML = `
    <b>‡§ï‡•Å‡§≤ ‡§™‡•Å‡§Å‡§ú‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ:</b> ${TOTAL.toFixed(2)}<br>
    ‡§µ‡§ø‡§§‡§∞‡§£ ‡§∞‡§ï‡§Æ: ${sumAmt.toFixed(2)} |
    ‡§µ‡§ø‡§§‡§∞‡§£ %: ${sumPct.toFixed(1)}%
    ${sumPct!==100 ? `<div class="warn">‚ö†Ô∏è ‡§ï‡•Å‡§≤ % 100 ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ</div>` : ``}
  `;
}

/* ===== Narration ===== */
function autoNarrate(){
  narration.value =
    "‡§Ø‡§∏ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ï‡•Å‡§≤ ‡§™‡•Å‡§Å‡§ú‡•Ä ‡§µ‡§ø‡§≠‡§ø‡§®‡•ç‡§® ‡§∏‡•ç‡§∞‡•ã‡§§‡§¨‡§æ‡§ü ‡§∏‡§®‡•ç‡§§‡•Å‡§≤‡§ø‡§§ ‡§∞‡•Ç‡§™‡§Æ‡§æ ‡§ú‡•Å‡§ü‡§æ‡§á‡§è‡§ï‡•ã ‡§õ‡•§ " +
    "‡§∏‡•ç‡§µ‚Äì‡§≤‡§ó‡§æ‡§®‡•Ä‡§≤‡•á ‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§ò‡§ü‡§æ‡§â‡§®‡•á ‡§∞ ‡§ã‡§£‡§≤‡•á ‡§µ‡§ø‡§∏‡•ç‡§§‡§æ‡§∞‡§≤‡§æ‡§à ‡§∏‡§Æ‡•ç‡§≠‡§µ ‡§¨‡§®‡§æ‡§â‡§®‡•á ‡§â‡§¶‡•ç‡§¶‡•á‡§∂‡•ç‡§Ø ‡§∞‡§æ‡§ñ‡§ø‡§è‡§ï‡•ã ‡§õ‡•§";
}
function saveNarration(){
  localStorage.setItem("fb_capital_narration", narration.value);
  alert("‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§≠‡§Ø‡•ã");
}

/* ===== Next ===== */
function goNext(){
  const pct = data.reduce((s,i)=>s+i.pct,0);
  if(pct!==100){
    alert("‡§ï‡•Å‡§≤ % 100 ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ");
    return;
  }
  location.href="income.html";
}

safeRender();
</script>
</body>
</html>
