<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Capital Source | FarmerBase BP Engine</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#f6f7f9;color:#222}
:root{--w:980px;--g:#1b5e20;--b:#ddd}

/* HEADER */
.header{position:sticky;top:0;z-index:100;background:#fff;border-bottom:1px solid var(--b)}
.header-inner{max-width:var(--w);margin:auto;padding:10px 14px}
.header h1{margin:0;font-size:16px}
.header .sub{font-size:12px;color:#555}

/* NAV */
.nav-bar{max-width:var(--w);margin:8px auto;padding:0 14px;display:flex;justify-content:space-between}
.nav-btn{text-decoration:none;font-size:13px;padding:6px 14px;border-radius:20px;border:1px solid #ccc;background:#fafafa;color:#222}
.nav-btn.primary{background:var(--g);color:#fff;border-color:var(--g)}
.top-nav{position:sticky;top:56px;z-index:90}
.bottom-nav{position:sticky;bottom:0;z-index:90}
.top-nav,.bottom-nav{pointer-events:auto}

/* MAIN */
.main{max-width:var(--w);margin:10px auto 20px;padding:0 14px;position:relative;z-index:2}
.card{background:#fff;border:1px solid var(--b);border-radius:8px;margin-bottom:16px}
.card h3{margin:0;padding:10px 12px;background:#f3f5f7;border-bottom:1px solid var(--b);font-size:14px}
.card .body{padding:12px;font-size:13px}

label{display:block;margin-top:6px;font-size:12px;color:#444}
input{
  width:100%;padding:6px;margin-top:4px;
  border:1px solid #ccc;border-radius:6px;font-size:13px
}

.btn{font-size:12px;padding:4px 10px;margin:6px 4px 0 0;cursor:pointer}
.btn.primary{color:#1b5e20;font-weight:600}
.btn.danger{color:#b71c1c}

.block{border-left:3px solid var(--g);padding-left:10px;margin-top:12px}
.small{font-size:11px;color:#555}

/* TABLE */
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid #ddd;padding:6px;font-size:12px}
th{background:#f3f5f7}

/* PRINT */
@media print{.nav-bar{display:none}body{background:#fff}}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <h1 id="pageTitle">‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ</h1>
    <div class="sub" id="pageSub">‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø / ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ</div>
  </div>
</div>

<!-- TOP NAV -->
<div class="nav-bar top-nav">
  <a href="expenses.html" class="nav-btn">‚¨ÖÔ∏è ‡§ñ‡§∞‡•ç‡§ö</a>
  <a href="income.html" class="nav-btn primary">‚û°Ô∏è ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</a>
</div>

<div class="main">

<!-- CAPITAL SOURCE -->
<div class="card">
  <h3>üè¶ ‡§™‡•Å‡§Å‡§ú‡•Ä‡§ï‡•ã ‡§∏‡•ç‡§∞‡•ã‡§§</h3>
  <div class="body">
    <button class="btn primary" id="addSourceBtn">‚ûï ‡§®‡§Ø‡§æ‡§Å ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
    <div id="sourceList"></div>
  </div>
</div>

<!-- SUMMARY -->
<div class="card">
  <h3>üìä ‡§™‡•Å‡§Å‡§ú‡•Ä ‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</h3>
  <div class="body" id="summary"></div>
</div>

</div>

<!-- BOTTOM NAV -->
<div class="nav-bar bottom-nav">
  <a href="expenses.html" class="nav-btn">‚¨ÖÔ∏è ‡§ñ‡§∞‡•ç‡§ö</a>
  <a href="income.html" class="nav-btn primary">‚û°Ô∏è ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</a>
</div>

<script>
/* ======================
   IDENTITY
====================== */
function getIdentity(){
  const B=JSON.parse(localStorage.getItem("fb_businesses")||"{}");
  const BID=B.activeId||"b1";
  return JSON.parse(localStorage.getItem("fb_short_info_"+BID)||"{}");
}
const info=getIdentity();
pageTitle.textContent=info.projectName||"‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ";
pageSub.textContent=info.businessName||"‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø / ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ";

/* ======================
   TOTAL EXPENSE
====================== */
function getTotalExpense(){
  const B=JSON.parse(localStorage.getItem("fb_businesses")||"{}");
  const BID=B.activeId||"b1";
  const e=JSON.parse(localStorage.getItem("fb_expenses_"+BID)||"{}");
  let sum=0;
  [...(e.current||[]),...(e.fixed||[])].forEach(x=>{
    sum+=(+x.qty||0)*(+x.rate||0);
  });
  return sum;
}
const TOTAL = getTotalExpense();

/* ======================
   STORAGE
====================== */
const B=JSON.parse(localStorage.getItem("fb_businesses")||"{}");
const BID=B.activeId||"b1";
const KEY="fb_capital_source_"+BID;

let sources=JSON.parse(localStorage.getItem(KEY)||"null");
if(!sources){
  sources=[
    {name:"‡§∏‡•ç‡§µ‡§≤‡§ó‡§æ‡§®‡•Ä",percent:40,interest:0,isLoan:false},
    {name:"‡§Ö‡§®‡•Å‡§¶‡§æ‡§®",percent:30,interest:0,isLoan:false},
    {name:"‡§¨‡•à‡§Ç‡§ï ‡§ã‡§£",percent:30,interest:12,isLoan:true}
  ];
}

/* ======================
   SAVE
====================== */
function save(){
  localStorage.setItem(KEY,JSON.stringify(sources));
  render();
}

/* ======================
   ADD
====================== */
addSourceBtn.addEventListener("click",()=>{
  sources.push({
    name:"",
    percent:0,
    interest:0,
    isLoan:false
  });
  save();
});

/* ======================
   RENDER
====================== */
function render(){
  sourceList.innerHTML="";
  let pctSum=0,totalInterest=0;

  sources.forEach((s,i)=>{
    const amt = TOTAL * ((+s.percent||0)/100);
    const interestAmt = s.isLoan ? amt*((+s.interest||0)/100) : 0;
    pctSum += (+s.percent||0);
    totalInterest += interestAmt;

    sourceList.innerHTML+=`
      <div class="block">
        <label>‡§∏‡•ç‡§∞‡•ã‡§§‡§ï‡•ã ‡§®‡§æ‡§Æ</label>
        <input value="${s.name}"
          oninput="sources[${i}].name=this.value"
          onblur="save()">

        <label>% ‡§µ‡§ø‡§§‡§∞‡§£</label>
        <input type="number" value="${s.percent}"
          oninput="sources[${i}].percent=this.value"
          onblur="save()">

        <label>‡§¨‡•ç‡§Ø‡§æ‡§ú‡§¶‡§∞ (%)</label>
        <input type="number" value="${s.interest}"
          ${s.isLoan?"":"readonly"}
          oninput="sources[${i}].interest=this.value"
          onblur="save()">

        <label>
          <input type="checkbox"
            ${s.isLoan?"checked":""}
            onchange="sources[${i}].isLoan=this.checked;save()">
          ‡§ã‡§£ ‡§π‡•ã ?
        </label>

        <div class="small">
          ‡§∞‡§ï‡§Æ: ‡§∞‡•Å ${amt.toLocaleString()}<br>
          ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§¨‡•ç‡§Ø‡§æ‡§ú: ‡§∞‡•Å ${interestAmt.toLocaleString()}
        </div>

        <button class="btn danger" onclick="sources.splice(${i},1);save()">
          üóëÔ∏è ‡§π‡§ü‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç
        </button>
      </div>`;
  });

  summary.innerHTML=`
    <div class="small">‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö: ‡§∞‡•Å ${TOTAL.toLocaleString()}</div>
    <div class="small">‡§ï‡•Å‡§≤ % ‡§µ‡§ø‡§§‡§∞‡§£: ${pctSum}%</div>
    <div class="small"><b>‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§ï‡•Å‡§≤ ‡§¨‡•ç‡§Ø‡§æ‡§ú:</b> ‡§∞‡•Å ${totalInterest.toLocaleString()}</div>
    ${pctSum!==100?'<div style="color:#b71c1c;font-size:12px">‚ö†Ô∏è % ‡§µ‡§ø‡§§‡§∞‡§£ 100% ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ</div>':""}
  `;
}

render();
</script>

</body>
</html>
