<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Income | FarmerBase BP Engine</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#f6f7f9;color:#222}
:root{--w:980px;--g:#1b5e20;--b:#ddd}

/* HEADER */
.header{position:sticky;top:0;z-index:100;background:#fff;border-bottom:1px solid var(--b)}
.header-inner{max-width:var(--w);margin:auto;padding:10px 14px}
.header h1{margin:0;font-size:16px}
.header .sub{font-size:12px;color:#555}

/* NAV */
.nav-bar{max-width:var(--w);margin:8px auto;padding:0 14px;display:flex;justify-content:space-between}
.nav-btn{text-decoration:none;font-size:13px;padding:6px 14px;border-radius:20px;border:1px solid #ccc;background:#fafafa;color:#222}
.nav-btn.primary{background:var(--g);color:#fff;border-color:var(--g)}
.top-nav{position:sticky;top:56px}
.bottom-nav{position:sticky;bottom:0}

/* MAIN */
.main{max-width:var(--w);margin:10px auto 20px;padding:0 14px}
.card{background:#fff;border:1px solid var(--b);border-radius:8px;margin-bottom:16px}
.card h3{margin:0;padding:10px 12px;background:#f3f5f7;border-bottom:1px solid var(--b);font-size:14px}
.card .body{padding:12px;font-size:13px}

table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:6px;font-size:12px;text-align:center}
th{background:#f3f5f7}

input{width:100%;padding:4px;border:1px solid #ccc;border-radius:4px;font-size:12px}

.small{font-size:11px;color:#555}

@media print{.nav-bar{display:none}}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <h1 id="pageTitle">‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ</h1>
    <div class="sub" id="pageSub">‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø / ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ</div>
  </div>
</div>

<div class="nav-bar top-nav">
  <a href="capital-source.html" class="nav-btn">‚¨ÖÔ∏è ‡§™‡•Å‡§Å‡§ú‡•Ä ‡§∏‡•ç‡§∞‡•ã‡§§</a>
  <a href="profit-loss.html" class="nav-btn primary">‚û°Ô∏è ‡§®‡§æ‡§´‡§æ‚Äì‡§®‡•ã‡§ï‡•ç‡§∏‡§æ‡§®</a>
</div>

<div class="main">

<div class="card">
  <h3>üí∞ ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä (Product-wise Income)</h3>
  <div class="body">
    <table>
      <thead>
        <tr>
          <th>‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®</th>
          <th>‡§á‡§ï‡§æ‡§à</th>
          <th>‡§™‡§∞‡§ø‡§Æ‡§æ‡§£</th>
          <th>‡§á‡§ï‡§æ‡§à‡§ó‡§§ ‡§≤‡§æ‡§ó‡§§</th>
          <th>‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§¶‡§∞</th>
          <th>Margin %</th>
          <th>‡§ï‡•Å‡§≤ ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</th>
        </tr>
      </thead>
      <tbody id="incomeTable"></tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>üìä ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</h3>
  <div class="body" id="summary"></div>
</div>

</div>

<div class="nav-bar bottom-nav">
  <a href="capital-source.html" class="nav-btn">‚¨ÖÔ∏è ‡§™‡•Å‡§Å‡§ú‡•Ä ‡§∏‡•ç‡§∞‡•ã‡§§</a>
  <a href="profit-loss.html" class="nav-btn primary">‚û°Ô∏è ‡§®‡§æ‡§´‡§æ‚Äì‡§®‡•ã‡§ï‡•ç‡§∏‡§æ‡§®</a>
</div>

<script>
/* ========= IDENTITY ========= */
const B = JSON.parse(localStorage.getItem("fb_businesses")||"{}");
const BID = B.activeId || "b1";
const info = JSON.parse(localStorage.getItem("fb_short_info_"+BID)||"{}");
pageTitle.textContent = info.projectName || "‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ";
pageSub.textContent   = info.businessName || "‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø";

/* ========= PRODUCTION ========= */
const PRODUCTS = JSON.parse(
  localStorage.getItem("fb_production_items_"+BID) || "[]"
);

/* ========= EXPENSES ========= */
const EXP = JSON.parse(
  localStorage.getItem("fb_expenses_"+BID) || "{}"
);

/* ========= STORAGE ========= */
const KEY = "fb_income_"+BID;
let income = JSON.parse(localStorage.getItem(KEY)||"{}");

/* ========= COST CALC ========= */
function calcUnitCost(prodName, qty){
  let total=0;

  [...(EXP.current||[]),...(EXP.fixed||[])].forEach(e=>{
    const amt=(+e.qty||0)*(+e.rate||0);
    if(e.applyType==="all"){
      total+=amt/PRODUCTS.length;
    }else if(e.products && e.products.includes(prodName)){
      total+=amt;
    }
  });

  return qty ? total/qty : 0;
}

/* ========= SAVE ========= */
function save(){localStorage.setItem(KEY,JSON.stringify(income));render();}

/* ========= RENDER ========= */
function render(){
  incomeTable.innerHTML="";
  let grand=0;

  PRODUCTS.forEach(p=>{
    const key=p.name;
    if(!income[key]) income[key]={price:"",margin:""};

    const qty=(+p.qty||0);
    const unitCost=calcUnitCost(p.name,qty);

    let price=+income[key].price||0;
    let margin=+income[key].margin||0;

    if(price && unitCost){
      margin=((price-unitCost)/unitCost*100).toFixed(2);
      income[key].margin=margin;
    }else if(margin && unitCost){
      price=(unitCost*(1+margin/100)).toFixed(2);
      income[key].price=price;
    }

    const total=price*qty;
    grand+=total;

    incomeTable.innerHTML+=`
      <tr>
        <td>${p.name}</td>
        <td>${p.unit||""}</td>
        <td>${qty}</td>
        <td>‡§∞‡•Å ${unitCost.toLocaleString()}</td>
        <td>
          <input type="number" value="${price}"
            oninput="income['${key}'].price=this.value;income['${key}'].margin='';save()">
        </td>
        <td>
          <input type="number" value="${margin}"
            oninput="income['${key}'].margin=this.value;income['${key}'].price='';save()">
        </td>
        <td>‡§∞‡•Å ${total.toLocaleString()}</td>
      </tr>
    `;
  });

  summary.innerHTML = `<b>‡§ï‡•Å‡§≤ ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä:</b> ‡§∞‡•Å ${grand.toLocaleString()}`;
}

render();
</script>

</body>
</html>
