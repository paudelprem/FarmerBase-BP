<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Create Letter | FarmerBase BP Engine</title>

<style>
body{margin:0;font-family:system-ui;background:#f4f6f8}
.wrap{max-width:900px;margin:auto;background:#fff;padding:20px}
h1,h2{margin:0;color:#1b5e20}
hr{border:none;border-top:1px solid #ddd;margin:16px 0}

label{font-size:13px;font-weight:600}
input,textarea{
  width:100%;padding:8px;font-size:13px;
  border:1px solid #ccc;border-radius:6px
}
textarea{resize:vertical;min-height:120px}

.box{border:1px solid #ddd;border-radius:8px;padding:12px;margin-bottom:16px}
.box h3{margin:0 0 8px;font-size:14px;color:#333}

.btn{
  padding:6px 14px;border-radius:20px;
  border:1px solid #ccc;background:#1b5e20;
  color:#fff;cursor:pointer;font-size:13px;margin-right:6px
}
.btn.light{background:#eee;color:#222}
.btn.danger{background:#b71c1c}

.small{font-size:12px;color:#555}

.footer{font-size:12px;color:#444;margin-top:30px}
@media print{.btn{display:none}}
</style>
</head>

<body>

<div class="wrap">

<!-- ACTIONS -->
<button class="btn light" onclick="location.href='letters.html'">тмЕя╕П рд╕рдмреИ рдирд┐рд╡реЗрджрди</button>
<button class="btn" onclick="window.print()">ЁЯЦия╕П Print / PDF</button>

<!-- HEADER -->
<h1 id="orgName">рд╕рдВрд╕реНрдерд╛рдХреЛ рдирд╛рдо</h1>
<div class="small" id="projectName"></div>

<hr>

<!-- OFFICE -->
<div class="box">
  <h3>ЁЯПв рдХрд╛рд░реНрдпрд╛рд▓рдпрдХреЛ рдирд╛рдо</h3>
  <textarea id="office" placeholder="рдХрд╛рд░реНрдпрд╛рд▓рдпрдХреЛ рдкреВрд░рд╛ рдирд╛рдо рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН"></textarea>
</div>

<!-- SUBJECT -->
<div class="box">
  <h3>ЁЯУМ рд╡рд┐рд╖рдп</h3>
  <input id="subject" placeholder="рд╡рд┐рд╖рдп рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН">
</div>

<!-- BODY -->
<div class="box">
  <h3>ЁЯУЭ рдирд┐рд╡реЗрджрдирдХреЛ рд╡реНрдпрд╣реЛрд░рд╛</h3>
  <textarea id="body" placeholder="рдирд┐рд╡реЗрджрдирдХреЛ рд╡реНрдпрд╣реЛрд░рд╛ рдпрд╣рд╛рдБ рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН"></textarea>
</div>

<!-- ATTACHMENT LIST -->
<div class="box">
  <h3>ЁЯУО рд╕рдВрд▓рдЧреНрди рдХрд╛рдЧрдЬрдкрддреНрд░рдХреЛ рд╕реВрдЪрд┐</h3>

  <div id="docs"></div>

  <button class="btn light" onclick="addDoc()">тЮХ рдмреБрдБрджрд╛ рдердкреНрдиреБрд╣реЛрд╕реН</button>

  <div class="small">
    (рдЙрджрд╛рд╣рд░рдг: рд╡реНрдпрд╡рд╕рд╛рдп рджрд░реНрддрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░рдХреЛ рдкреНрд░рддрд┐рд▓рд┐рдкрд┐)
  </div>
</div>

<!-- FOOTER -->
<div class="footer" id="footerInfo"></div>

</div>

<script>
/* ========= BUSINESS ========= */
const B = JSON.parse(localStorage.getItem("fb_businesses")||"{}");
const BID = B.activeId || "b1";
const info = JSON.parse(localStorage.getItem("fb_short_info_"+BID)||"{}");

/* ========= ACTIVE LETTER ========= */
const activeId = localStorage.getItem("fb_active_letter_"+BID);
const LIST_KEY = "fb_letters_list_"+BID;
let list = JSON.parse(localStorage.getItem(LIST_KEY)||"[]");
let letter = list.find(l=>l.id==activeId);

if(!letter){
  letter={id:activeId,office:"",subject:"",body:"",docs:[],updated:new Date().toISOString()};
  list.unshift(letter);
}

/* ========= HEADER ========= */
orgName.textContent = info.businessName || "рд╕рдВрд╕реНрдерд╛рдХреЛ рдирд╛рдо";
projectName.textContent = info.projectName || "";

/* ========= FOOTER ========= */
footerInfo.innerHTML = `
<b>${info.businessName||""}</b><br>
рджрд░реНрддрд╛ рдирдВ: ${info.regNo||"-"} |
PAN рдирдВ: ${info.pan||"-"}<br>
рдареЗрдЧрд╛рдирд╛: ${info.address||""}
`;

/* ========= BIND ========= */
office.value = letter.office || "";
subject.value = letter.subject || "";
body.value = letter.body || "";

office.onblur = ()=>{letter.office=office.value;save()};
subject.onblur = ()=>{letter.subject=subject.value;save()};
body.onblur = ()=>{letter.body=body.value;save()};

/* ========= DOC LIST ========= */
function addDoc(){
  letter.docs.push("");
  save();
}

function renderDocs(){
  docs.innerHTML="";
  letter.docs.forEach((d,i)=>{
    docs.innerHTML+=`
      <div style="display:flex;gap:6px;margin-bottom:6px">
        <input placeholder="рд╕рдВрд▓рдЧреНрди рдХрд╛рдЧрдЬрдкрддреНрд░"
          value="${d}"
          onblur="letter.docs[${i}]=this.value;save()">
        <button class="btn danger"
          onclick="letter.docs.splice(${i},1);save()">тЬЦ</button>
      </div>
    `;
  });
}

/* ========= SAVE ========= */
function save(){
  letter.updated = new Date().toISOString();
  localStorage.setItem(LIST_KEY,JSON.stringify(list));
  renderDocs();
}

renderDocs();
</script>

</body>
</html>
