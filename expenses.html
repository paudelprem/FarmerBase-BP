<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Expenses | FarmerBase BP Engine</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#f6f7f9;color:#222}
:root{--w:980px;--g:#1b5e20;--b:#ddd}

/* HEADER */
.header{position:sticky;top:0;z-index:100;background:#fff;border-bottom:1px solid var(--b)}
.header-inner{max-width:var(--w);margin:auto;padding:10px 14px}
.header h1{margin:0;font-size:16px}
.header .sub{font-size:12px;color:#555}

/* NAV */
.nav-bar{max-width:var(--w);margin:8px auto;padding:0 14px;display:flex;justify-content:space-between}
.nav-btn{text-decoration:none;font-size:13px;padding:6px 14px;border-radius:20px;border:1px solid #ccc;background:#fafafa;color:#222}
.nav-btn.primary{background:var(--g);color:#fff;border-color:var(--g)}
.top-nav{position:sticky;top:56px}
.bottom-nav{position:sticky;bottom:0}

/* MAIN */
.main{max-width:var(--w);margin:10px auto 20px;padding:0 14px}
.card{background:#fff;border:1px solid var(--b);border-radius:8px;margin-bottom:16px}
.card h3{margin:0;padding:10px 12px;background:#f3f5f7;border-bottom:1px solid var(--b);font-size:14px}
.card .body{padding:12px;font-size:13px}

table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:6px;font-size:12px;text-align:center}
th{background:#f3f5f7}

input,select{width:100%;padding:4px;font-size:12px}
.small{font-size:11px;color:#555}
.btn{font-size:12px;padding:4px 10px;margin:4px;cursor:pointer}
.btn.primary{color:#1b5e20;font-weight:600}
.btn.danger{color:#b71c1c}
.collapsed{background:#fafafa}
.warn{color:#b71c1c;font-size:12px;margin-top:6px}

@media print{.nav-bar{display:none}}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <h1 id="pageTitle">рдкрд░рд┐рдпреЛрдЬрдирд╛рдХреЛ рдирд╛рдо</h1>
    <div class="sub" id="pageSub">рд╡реНрдпрд╡рд╕рд╛рдп / рд╕рдВрд╕реНрдерд╛рдХреЛ рдирд╛рдо</div>
  </div>
</div>

<div class="nav-bar top-nav">
  <a href="production.html" class="nav-btn">тмЕя╕П рдЙрддреНрдкрд╛рджрди</a>
  <a href="capital-source.html" class="nav-btn primary">тЮбя╕П рдкреБрдБрдЬреА рд╕реНрд░реЛрдд</a>
</div>

<div class="main">

<div class="card">
  <h3>ЁЯФД рдЪрд╛рд▓реБ рдЦрд░реНрдЪ (Current Expenses)</h3>
  <div class="body">
    <button class="btn primary" onclick="addRow('current')">тЮХ рдЪрд╛рд▓реБ рдЦрд░реНрдЪ рдердкреНрдиреБрд╣реЛрд╕реН</button>
    <table>
      <thead>
        <tr>
          <th>рд╡рд┐рд╡рд░рдг</th><th>рдЗрдХрд╛рдИ</th><th>рдкрд░рд┐рдорд╛рдг</th><th>рджрд░</th>
          <th>рдХреЗрдорд╛ рд▓рд╛рдЧреНрдиреЗ?</th><th>рд▓рд╛рдЧрдд</th><th></th>
        </tr>
      </thead>
      <tbody id="currentTable"></tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>ЁЯПЧя╕П рд╕реНрдерд┐рд░ рдЦрд░реНрдЪ / рд╕рдореНрдкрддреНрддрд┐ (Fixed Assets)</h3>
  <div class="body">
    <button class="btn primary" onclick="addRow('fixed')">тЮХ рд╕реНрдерд┐рд░ рдЦрд░реНрдЪ рдердкреНрдиреБрд╣реЛрд╕реН</button>
    <table>
      <thead>
        <tr>
          <th>рд╕рдореНрдкрддреНрддрд┐</th><th>рдЗрдХрд╛рдИ</th><th>рдкрд░рд┐рдорд╛рдг</th><th>рджрд░</th>
          <th>рд╣реНрд░рд╛рд╕ %</th><th>рд╡рд╛рд░реНрд╖рд┐рдХ рд╣реНрд░рд╛рд╕</th>
          <th>рдХреЗрдорд╛ рд▓рд╛рдЧреНрдиреЗ?</th><th>рд▓рд╛рдЧрдд</th><th></th>
        </tr>
      </thead>
      <tbody id="fixedTable"></tbody>
    </table>
  </div>
</div>

</div>

<div class="nav-bar bottom-nav">
  <a href="production.html" class="nav-btn">тмЕя╕П рдЙрддреНрдкрд╛рджрди</a>
  <a href="capital-source.html" class="nav-btn primary">тЮбя╕П рдкреБрдБрдЬреА рд╕реНрд░реЛрдд</a>
</div>

<script>
/* ========= IDENTITY ========= */
const B=JSON.parse(localStorage.getItem("fb_businesses")||"{}");
const BID=B.activeId||"b1";
const info=JSON.parse(localStorage.getItem("fb_short_info_"+BID)||"{}");
pageTitle.textContent=info.projectName||"рдкрд░рд┐рдпреЛрдЬрдирд╛рдХреЛ рдирд╛рдо";
pageSub.textContent=info.businessName||"рд╡реНрдпрд╡рд╕рд╛рдп";

/* ========= PRODUCTION ========= */
const PRODUCTS=JSON.parse(localStorage.getItem("fb_production_items_"+BID)||"[]");

/* ========= STORAGE ========= */
const KEY="fb_expenses_"+BID;
let data=JSON.parse(localStorage.getItem(KEY)||"null");
if(!data){
  data={current:[],fixed:[]};
}

/* ========= SAVE ========= */
function save(){
  localStorage.setItem(KEY,JSON.stringify(data));
  render();
}

/* ========= ADD ROW ========= */
function addRow(type){
  const row={
    name:"",unit:"",qty:1,rate:0,
    depRate:10,
    applyType:"selected",
    products:[],
    collapsed:false
  };
  data[type].unshift(row);
  save();
}

/* ========= RENDER ========= */
function render(){
  renderTable("current",currentTable,false);
  renderTable("fixed",fixedTable,true);
}

/* ========= TABLE RENDER ========= */
function renderTable(type,el,hasDep){
  el.innerHTML="";
  data[type].forEach((e,i)=>{
    const cost=(+e.qty||0)*(+e.rate||0);
    const dep=hasDep?cost*((+e.depRate||0)/100):0;

    el.innerHTML+=`
    <tr class="${e.collapsed?'collapsed':''}">
      <td><input value="${e.name}" onblur="data.${type}[${i}].name=this.value;save()"></td>
      <td><input value="${e.unit}" onblur="data.${type}[${i}].unit=this.value;save()"></td>
      <td><input type="number" value="${e.qty}" onblur="data.${type}[${i}].qty=this.value;save()"></td>
      <td><input type="number" value="${e.rate}" onblur="data.${type}[${i}].rate=this.value;save()"></td>

      ${hasDep?`
      <td><input type="number" value="${e.depRate}" onblur="data.${type}[${i}].depRate=this.value;save()"></td>
      <td>рд░реБ ${dep.toLocaleString()}</td>`:""}

      <td>
        <select onchange="data.${type}[${i}].applyType=this.value;save()">
          <option value="all" ${e.applyType==="all"?"selected":""}>рд╕рдмреИ рдЙрддреНрдкрд╛рджрди</option>
          <option value="selected" ${e.applyType==="selected"?"selected":""}>рдЫрд╛рдирд┐рдПрдХрд╛</option>
        </select>
        ${e.applyType==="selected"?`
          <div class="small">
            ${PRODUCTS.map(p=>`
              <label>
                <input type="checkbox"
                  ${e.products.includes(p.name)?"checked":""}
                  onchange="
                    const a=data.${type}[${i}].products;
                    this.checked?a.push('${p.name}'):a.splice(a.indexOf('${p.name}'),1);
                    save();
                  ">
                ${p.name}
              </label>
            `).join("")}
          </div>`:""}
      </td>

      <td>рд░реБ ${cost.toLocaleString()}</td>

      <td>
        <button class="btn" onclick="data.${type}[${i}].collapsed=!data.${type}[${i}].collapsed;save()">тЦ╛</button>
        <button class="btn danger" onclick="data.${type}.splice(${i},1);save()">ЁЯЧСя╕П</button>
      </td>
    </tr>`;
  });
}

render();
</script>

</body>
</html>

