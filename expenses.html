<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Expenses | FarmerBase BP Engine</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#f6f7f9;color:#222}
:root{--w:980px;--g:#1b5e20;--b:#ddd}

/* HEADER */
.header{position:sticky;top:0;z-index:100;background:#fff;border-bottom:1px solid var(--b)}
.header-inner{max-width:var(--w);margin:auto;padding:10px 14px}
.header h1{margin:0;font-size:16px}
.header .sub{font-size:12px;color:#555}

/* NAV */
.nav-bar{max-width:var(--w);margin:8px auto;padding:0 14px;display:flex;justify-content:space-between}
.nav-btn{text-decoration:none;font-size:13px;padding:6px 14px;border-radius:20px;border:1px solid #ccc;background:#fafafa;color:#222}
.nav-btn.primary{background:var(--g);color:#fff;border-color:var(--g)}
.top-nav{position:sticky;top:56px;z-index:90}
.bottom-nav{position:sticky;bottom:0;z-index:90}
.top-nav,.bottom-nav{pointer-events:auto}

/* MAIN */
.main{max-width:var(--w);margin:10px auto 20px;padding:0 14px}
.card{background:#fff;border:1px solid var(--b);border-radius:8px;margin-bottom:16px}
.card h3{margin:0;padding:10px 12px;background:#f3f5f7;border-bottom:1px solid var(--b);font-size:14px}
.card .body{padding:12px;font-size:13px}

label{display:block;margin-top:6px;font-size:12px}
input{width:100%;padding:6px;margin-top:4px;border:1px solid #ccc;border-radius:6px}
input[readonly]{background:#f9f9f9}

.btn{font-size:12px;padding:4px 10px;margin:6px 4px 0 0;cursor:pointer}
.btn.primary{color:#1b5e20;font-weight:600}
.btn.danger{color:#b71c1c}

.block{border-left:3px solid var(--g);padding-left:10px;margin-top:10px}
.small{font-size:11px;color:#555}

/* COLLAPSE */
.collapsed .edit-area{display:none}
.collapsed .summary{display:block}
.summary{display:none}

@media print{.nav-bar{display:none}}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <h1 id="pageTitle">рдкрд░рд┐рдпреЛрдЬрдирд╛рдХреЛ рдирд╛рдо</h1>
    <div class="sub" id="pageSub">рд╡реНрдпрд╡рд╕рд╛рдп / рд╕рдВрд╕реНрдерд╛рдХреЛ рдирд╛рдо</div>
  </div>
</div>

<!-- NAV -->
<div class="nav-bar top-nav">
  <a href="production.html" class="nav-btn">тмЕя╕П рдЙрддреНрдкрд╛рджрди</a>
  <a href="capital-source.html" class="nav-btn primary">тЮбя╕П рдкреБрдБрдЬреА рд╕реНрд░реЛрдд</a>
</div>

<div class="main">

<!-- CURRENT -->
<div class="card">
  <h3>ЁЯТ╕ рдЪрд╛рд▓реБ рдЦрд░реНрдЪ</h3>
  <div class="body">
    <button class="btn primary" id="addCurrent">тЮХ рдирдпрд╛рдБ рдЦрд░реНрдЪ</button>
    <div id="currentList"></div>
  </div>
</div>

<!-- FIXED -->
<div class="card">
  <h3>ЁЯПЧя╕П рд╕реНрдерд┐рд░ (рдкреБрдБрдЬреАрдЧрдд) рдЦрд░реНрдЪ</h3>
  <div class="body">
    <button class="btn primary" id="addFixed">тЮХ рдирдпрд╛рдБ рдЦрд░реНрдЪ</button>
    <div id="fixedList"></div>
  </div>
</div>

</div>

<!-- NAV BOTTOM -->
<div class="nav-bar bottom-nav">
  <a href="production.html" class="nav-btn">тмЕя╕П рдЙрддреНрдкрд╛рджрди</a>
  <a href="capital-source.html" class="nav-btn primary">тЮбя╕П рдкреБрдБрдЬреА рд╕реНрд░реЛрдд</a>
</div>

<script>
/* ================= IDENTITY ================= */
const B = JSON.parse(localStorage.getItem("fb_businesses")||"{}");
const BID = B.activeId || "b1";
const info = JSON.parse(localStorage.getItem("fb_short_info_"+BID)||"{}");
pageTitle.textContent = info.projectName || "рдкрд░рд┐рдпреЛрдЬрдирд╛рдХреЛ рдирд╛рдо";
pageSub.textContent   = info.businessName || "рд╡реНрдпрд╡рд╕рд╛рдп";

/* ================= PRODUCTS ================= */
const PRODUCTS = JSON.parse(
  localStorage.getItem("fb_production_items_"+BID) || "[]"
);

/* ================= STORAGE ================= */
const KEY = "fb_expenses_"+BID;
let data = JSON.parse(localStorage.getItem(KEY)||"null");
if(!data) data = { current:[], fixed:[] };

function save(){
  localStorage.setItem(KEY, JSON.stringify(data));
  render();
}

/* ================= ADD (PREPEND) ================= */
function add(type){
  data[type].unshift({
    title:"",
    unit:"",
    qty:"",
    rate:"",
    applyType:"selected", // all | selected
    products:[],
    edit:true
  });
  save();
}

addCurrent.onclick = ()=>add("current");
addFixed.onclick   = ()=>add("fixed");

/* ================= RENDER ================= */
function renderList(type, wrap){
  wrap.innerHTML="";
  data[type].forEach((e,i)=>{
    const qty = (+e.qty||0);
    const rate = (+e.rate||0);
    const amt = qty * rate;
    const per = qty ? amt/qty : 0;

    wrap.innerHTML += `
    <div class="block ${!e.edit?'collapsed':''}">
      <div class="summary">
        <b>${e.title || "(рд╢реАрд░реНрд╖рдХ)"}</b><br>
        <span class="small">
          рдЗрдХрд╛рдИрдЧрдд: рд░реБ ${per.toLocaleString()} |
          рдХреБрд▓: рд░реБ ${amt.toLocaleString()}
        </span>
      </div>

      <div class="edit-area">
        <label>рдЦрд░реНрдЪ рд╢реАрд░реНрд╖рдХ</label>
        <input value="${e.title}"
          oninput="data.${type}[${i}].title=this.value">

        <label>рдЗрдХрд╛рдИ</label>
        <input value="${e.unit}"
          oninput="data.${type}[${i}].unit=this.value">

        <label>рдкрд░рд┐рдорд╛рдг</label>
        <input type="number" value="${e.qty}"
          oninput="data.${type}[${i}].qty=this.value">

        <label>рджрд░</label>
        <input type="number" value="${e.rate}"
          oninput="data.${type}[${i}].rate=this.value">

        <label><b>рдЦрд░реНрдЪрдХреЛ рдкреНрд░рдХреГрддрд┐</b></label>
        <label>
          <input type="radio" name="ap_${type}_${i}"
            ${e.applyType==="all"?"checked":""}
            onchange="data.${type}[${i}].applyType='all';save()">
          рд╕рдмреИ рдЙрддреНрдкрд╛рджрдирдорд╛ рд▓рд╛рдЧреНрдиреЗ
        </label>
        <label>
          <input type="radio" name="ap_${type}_${i}"
            ${e.applyType==="selected"?"checked":""}
            onchange="data.${type}[${i}].applyType='selected';save()">
          рдХреЗрд╣реА рдЙрддреНрдкрд╛рджрдирдорд╛ рдорд╛рддреНрд░ рд▓рд╛рдЧреНрдиреЗ
        </label>

        ${
          e.applyType==="selected"
          ? (
            PRODUCTS.length===0
            ? `<div class="small" style="color:#b71c1c">
                тЪая╕П рдЙрддреНрдкрд╛рджрди рд╕реВрдЪреА рдЦрд╛рд▓реА рдЫ (рдкрд╣рд┐рд▓реЗ production рднрд░реНрдиреБрд╣реЛрд╕реН)
              </div>`
            : `
              <div class="small"><b>рдХреЗрдорд╛ рд▓рдЧрд╛рдиреА?</b></div>
              ${PRODUCTS.map(p=>`
                <label>
                  <input type="checkbox"
                    ${e.products.includes(p.name)?"checked":""}
                    onchange="
                      const arr=data.${type}[${i}].products;
                      this.checked
                        ? arr.push('${p.name}')
                        : arr.splice(arr.indexOf('${p.name}'),1);
                      save();
                    ">
                  ${p.name}
                </label>
              `).join("")}
            `
          )
          : ""
        }
      </div>

      ${
        e.edit
        ? `<button class="btn primary"
             onclick="data.${type}[${i}].edit=false;save()">ЁЯТ╛ Save</button>`
        : `<button class="btn primary"
             onclick="data.${type}[${i}].edit=true;save()">тЬПя╕П Edit</button>`
      }
      <button class="btn danger"
        onclick="data.${type}.splice(${i},1);save()">ЁЯЧСя╕П рд╣рдЯрд╛рдЙрдиреБрд╣реЛрд╕реН</button>
    </div>
    `;
  });
}

function render(){
  renderList("current", currentList);
  renderList("fixed", fixedList);
}
render();
</script>

</body>
</html>
