<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>рдЦрд░реНрдЪ рд╡рд┐рд╡рд░рдг | FarmerBase BP Engine</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#f6f7f9;color:#222}
:root{--w:980px;--g:#1b5e20;--b:#ddd}

/* NAV */
.nav-bar{
  max-width:var(--w);margin:8px auto;padding:8px 14px;
  display:flex;justify-content:space-between;background:#f6f7f9
}
.nav-btn{
  text-decoration:none;font-size:13px;padding:6px 14px;
  border-radius:20px;border:1px solid #ccc;
  background:#fafafa;color:#222
}
.nav-btn.primary{background:var(--g);color:#fff;border-color:var(--g)}
.top-nav{position:sticky;top:0;z-index:100}
.bottom-nav{position:sticky;bottom:0;z-index:100}

/* Layout */
.main{max-width:var(--w);margin:10px auto 20px;padding:0 14px}
.card{
  background:#fff;border:1px solid var(--b);
  border-radius:8px;margin-bottom:16px
}
.card h3{
  margin:0;padding:10px 12px;background:#f3f5f7;
  border-bottom:1px solid var(--b);font-size:14px
}
.card .body{padding:12px;font-size:13px}

input,select,textarea{
  width:100%;padding:6px;margin:4px 0;
  border:1px solid #ccc;border-radius:6px;font-size:13px
}
textarea[readonly],input[readonly]{background:#f9f9f9;border-color:#eee}

.btn{
  font-size:12px;padding:4px 10px;margin:4px 4px 0 0;cursor:pointer
}
.btn.primary{color:#1b5e20;font-weight:600}
.btn.danger{color:#b71c1c}

.subcat{
  border-left:3px solid var(--g);
  padding-left:10px;
  margin-top:14px
}

table{
  width:100%;border-collapse:collapse;margin-top:6px
}
th,td{
  border:1px solid #ddd;padding:6px;font-size:12px;text-align:left
}
th{background:#f3f5f7}
.total{font-weight:600;margin-top:6px}
.small{font-size:11px;color:#555}
</style>
</head>

<body>

<!-- TOP NAV -->
<div class="nav-bar top-nav">
  <a href="production.html" class="nav-btn">тмЕя╕П рдЙрддреНрдкрд╛рджрди рд╡рд┐рд╡рд░рдг</a>
  <a href="income.html" class="nav-btn primary">тЮбя╕П рдЖрдореНрджрд╛рдиреА</a>
</div>

<div class="main">

<!-- NARRATION -->
<div class="card">
  <h3>ЁЯУЭ рдЦрд░реНрдЪ рд╕рдордЧреНрд░ рдЯрд┐рдкреНрдкрдгреА (Narration)</h3>
  <div class="body">
    <textarea id="expenseNarration" rows="3"
      placeholder="рдЦрд░реНрдЪрдХреЛ рд╕рдордЧреНрд░ рдЕрд╡рд╕реНрдерд╛, рдЕрдиреБрдорд╛рдирдХреЛ рдЖрдзрд╛рд░, рд╡рд┐рд╢реЗрд╖ рдЯрд┐рдкреНрдкрдгреА..."></textarea>
  </div>
</div>

<!-- EXPENSES -->
<div class="card">
  <h3>ЁЯТ╕ рдЦрд░реНрдЪ рд╡рд┐рд╡рд░рдг</h3>
  <div class="body">
    <button class="btn primary" onclick="addSub('рдЪрд▓реБ')">тЮХ рдЪрд╛рд▓реБ рдЦрд░реНрдЪ рдЙрдкрд╢реАрд░реНрд╖рдХ</button>
    <button class="btn primary" onclick="addSub('рд╕реНрдерд┐рд░')">тЮХ рд╕реНрдерд┐рд░ рдкреБрдБрдЬреА рдЙрдкрд╢реАрд░реНрд╖рдХ</button>
    <div id="expenseArea"></div>
  </div>
</div>

</div>

<!-- BOTTOM NAV -->
<div class="nav-bar bottom-nav">
  <a href="production.html" class="nav-btn">тмЕя╕П рдЙрддреНрдкрд╛рджрди рд╡рд┐рд╡рд░рдг</a>
  <a href="income.html" class="nav-btn primary">тЮбя╕П рдЖрдореНрджрд╛рдиреА</a>
</div>

<script>
/* CONTEXT */
const B = JSON.parse(localStorage.getItem("fb_businesses")||"{}");
const BID = B.activeId || "b1";

/* PRODUCTS (for mapping) */
const products = JSON.parse(
  localStorage.getItem("fb_production_items_"+BID) || "[]"
);

/* DATA */
const KEY="fb_expenses_v2_"+BID;
let data = JSON.parse(localStorage.getItem(KEY) || "null");
if(!data){
  data = { narration:"", subs:[] };
}

/* SAVE */
function save(){
  localStorage.setItem(KEY, JSON.stringify(data));
  render();
}

/* NARRATION */
expenseNarration.value = data.narration || "";
expenseNarration.oninput = ()=>{
  data.narration = expenseNarration.value;
  save();
};

/* SUBCATEGORY */
function addSub(type){
  data.subs.push({
    type,
    title:"",
    edit:true,
    items:[]
  });
  save();
}
function editSub(i){ data.subs[i].edit=true; render(); }
function saveSub(i){ data.subs[i].edit=false; save(); }
function deleteSub(i){
  if(!confirm("рдпреЛ рдЙрдкрд╢реАрд░реНрд╖рдХ рд╣рдЯрд╛рдЙрдиреЗ?"))return;
  data.subs.splice(i,1); save();
}

/* ITEMS */
function addItem(si){
  data.subs[si].items.push({
    name:"",unit:"",qty:"",rate:"",
    product:"",
    years: data.subs[si].type==="рд╕реНрдерд┐рд░"?5:null
  });
  save();
}
function deleteItem(si,ii){
  if(!confirm("рдпреЛ рд╡рд┐рд╡рд░рдг рд╣рдЯрд╛рдЙрдиреЗ?"))return;
  data.subs[si].items.splice(ii,1); save();
}

/* RENDER */
function render(){
  const wrap=document.getElementById("expenseArea");
  wrap.innerHTML="";

  data.subs.forEach((s,si)=>{
    let subTotal=0;

    const div=document.createElement("div");
    div.className="subcat";

    div.innerHTML=`
      <b>${s.type} рдЦрд░реНрдЪ</b>
      <div>
        <input ${s.edit?"":"readonly"} value="${s.title}"
          placeholder="рдЙрдкрд╢реАрд░реНрд╖рдХ рдирд╛рдо"
          oninput="data.subs[${si}].title=this.value">
        ${s.edit?`
          <button class="btn primary" onclick="saveSub(${si})">ЁЯТ╛</button>
        `:`
          <button class="btn primary" onclick="editSub(${si})">тЬПя╕П</button>
        `}
        <button class="btn danger" onclick="deleteSub(${si})">ЁЯЧСя╕П</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>рд╕рд╛рдорд╛рди/рд╕реЗрд╡рд╛</th>
            <th>рдпреБрдирд┐рдЯ</th>
            <th>рд╕рдВрдЦреНрдпрд╛</th>
            <th>рджрд░</th>
            <th>рдХреБрд▓</th>
            <th>рдЙрддреНрдкрд╛рджрди</th>
            ${s.type==="рд╕реНрдерд┐рд░"?'<th>рд╣реНрд░рд╛рд╕ (рд╡рд░реНрд╖)</th><th>рд╡рд╛рд░реНрд╖рд┐рдХ</th>':""}
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${s.items.map((it,ii)=>{
            const total=(it.qty*it.rate)||0;
            subTotal+=total;
            const yearly = s.type==="рд╕реНрдерд┐рд░" && it.years
              ? (total/it.years).toFixed(2) : "";
            return `
            <tr>
              <td><input value="${it.name}"
                oninput="data.subs[${si}].items[${ii}].name=this.value;save()"></td>
              <td><input value="${it.unit}"
                oninput="data.subs[${si}].items[${ii}].unit=this.value;save()"></td>
              <td><input type="number" value="${it.qty}"
                oninput="data.subs[${si}].items[${ii}].qty=this.value;save()"></td>
              <td><input type="number" value="${it.rate}"
                oninput="data.subs[${si}].items[${ii}].rate=this.value;save()"></td>
              <td>${total}</td>
              <td>
                <select onchange="data.subs[${si}].items[${ii}].product=this.value;save()">
                  <option value="">тАФ</option>
                  ${products.map(p=>`
                    <option ${p.name===it.product?"selected":""}>${p.name}</option>
                  `).join("")}
                </select>
              </td>
              ${s.type==="рд╕реНрдерд┐рд░"?`
                <td><input type="number" value="${it.years||""}"
                  oninput="data.subs[${si}].items[${ii}].years=this.value;save()"></td>
                <td>${yearly}</td>
              `:""}
              <td>
                <button class="btn danger"
                  onclick="deleteItem(${si},${ii})">тЬЦ</button>
              </td>
            </tr>`;
          }).join("")}
        </tbody>
      </table>

      <button class="btn primary" onclick="addItem(${si})">тЮХ рд╡рд┐рд╡рд░рдг рдердкреНрдиреБрд╣реЛрд╕реН</button>
      <div class="total">рдЙрдкрд╢реАрд░реНрд╖рдХ рдХреБрд▓: рд░реБ ${subTotal}</div>
    `;
    wrap.appendChild(div);
  });
}
render();
</script>

</body>
</html>
