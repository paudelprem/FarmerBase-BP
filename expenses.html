<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Expenses | FarmerBase BP Engine</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#f6f7f9;color:#222}
:root{--w:980px;--g:#1b5e20;--b:#ddd}

/* HEADER */
.header{position:sticky;top:0;z-index:100;background:#fff;border-bottom:1px solid var(--b)}
.header-inner{max-width:var(--w);margin:auto;padding:10px 14px}
.header h1{margin:0;font-size:16px}
.header .sub{font-size:12px;color:#555}

/* NAV */
.nav-bar{max-width:var(--w);margin:8px auto;padding:0 14px;display:flex;justify-content:space-between}
.nav-btn{text-decoration:none;font-size:13px;padding:6px 14px;border-radius:20px;border:1px solid #ccc;background:#fafafa;color:#222}
.nav-btn.primary{background:var(--g);color:#fff;border-color:var(--g)}
.top-nav{position:sticky;top:56px;z-index:90}
.bottom-nav{position:sticky;bottom:0;z-index:90}
.top-nav,.bottom-nav{pointer-events:auto}

/* MAIN */
.main{max-width:var(--w);margin:10px auto 20px;padding:0 14px;position:relative;z-index:2}
.card{background:#fff;border:1px solid var(--b);border-radius:8px;margin-bottom:16px}
.card h3{margin:0;padding:10px 12px;background:#f3f5f7;border-bottom:1px solid var(--b);font-size:14px}
.card .body{padding:12px;font-size:13px}

label{display:block;margin-top:6px;font-size:12px;color:#444}
input,select,textarea{
  width:100%;padding:6px;margin-top:4px;
  border:1px solid #ccc;border-radius:6px;font-size:13px
}
input[readonly],textarea[readonly]{background:#f9f9f9;border-color:#eee}

.btn{font-size:12px;padding:4px 10px;margin:4px 4px 0 0;cursor:pointer}
.btn.primary{color:#1b5e20;font-weight:600}
.btn.danger{color:#b71c1c}

.block{border-left:3px solid var(--g);padding-left:10px;margin-top:12px}

/* TABLE */
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid #ddd;padding:6px;font-size:12px}
th{background:#f3f5f7}
.small{font-size:11px;color:#555}

/* PRINT */
@media print{.nav-bar{display:none}body{background:#fff}}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <h1 id="pageTitle">‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ</h1>
    <div class="sub" id="pageSub">‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø / ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ</div>
  </div>
</div>

<!-- TOP NAV -->
<div class="nav-bar top-nav">
  <a href="production.html" class="nav-btn">‚¨ÖÔ∏è ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®</a>
  <a href="income.html" class="nav-btn primary">‚û°Ô∏è ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</a>
</div>

<div class="main">

<!-- CURRENT EXPENSE -->
<div class="card">
  <h3>üí∏ ‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö</h3>
  <div class="body">
    <button class="btn primary" onclick="addExpense('current')">‚ûï ‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
    <div id="currentList"></div>
  </div>
</div>

<!-- FIXED EXPENSE -->
<div class="card">
  <h3>üèóÔ∏è ‡§∏‡•ç‡§•‡§ø‡§∞ (‡§™‡•Å‡§Å‡§ú‡•Ä‡§ó‡§§) ‡§ñ‡§∞‡•ç‡§ö</h3>
  <div class="body">
    <button class="btn primary" onclick="addExpense('fixed')">‚ûï ‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
    <div id="fixedList"></div>
  </div>
</div>

<!-- SUMMARY -->
<div class="card">
  <h3>üìä ‡§ñ‡§∞‡•ç‡§ö‡§ï‡•ã ‡§µ‡§ø‡§ß‡§æ‡§ó‡§§ ‡§∏‡§Æ‡§∞‡•Ä</h3>
  <div class="body" id="summary"></div>
</div>

</div>

<!-- BOTTOM NAV -->
<div class="nav-bar bottom-nav">
  <a href="production.html" class="nav-btn">‚¨ÖÔ∏è ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®</a>
  <a href="income.html" class="nav-btn primary">‚û°Ô∏è ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</a>
</div>

<script>
/* ======================
   IDENTITY
====================== */
function getIdentity(){
  const B=JSON.parse(localStorage.getItem("fb_businesses")||"{}");
  const BID=B.activeId||"b1";
  return JSON.parse(localStorage.getItem("fb_short_info_"+BID)||"{}");
}
const info=getIdentity();
pageTitle.textContent=info.projectName||"‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ";
pageSub.textContent=info.businessName||"‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø / ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ";

/* ======================
   STORAGE
====================== */
const B=JSON.parse(localStorage.getItem("fb_businesses")||"{}");
const BID=B.activeId||"b1";
const KEY="fb_expenses_"+BID;

let data=JSON.parse(localStorage.getItem(KEY)||"null");
if(!data){
  data={current:[],fixed:[]};
}

/* ======================
   SAVE
====================== */
function save(){
  localStorage.setItem(KEY,JSON.stringify(data));
  render();
}

/* ======================
   ADD
====================== */
function addExpense(type){
  data[type].push({
    title:"",
    unit:"",
    qty:"",
    rate:"",
    note:"",
    edit:true,
    backup:{}
  });
  save();
}

/* ======================
   CRUD
====================== */
function edit(type,i){
  data[type][i].backup={...data[type][i]};
  data[type][i].edit=true;render();
}
function saveRow(type,i){
  data[type][i].edit=false;save();
}
function cancel(type,i){
  data[type][i]={...data[type][i].backup,edit:false};save();
}
function del(type,i){
  if(!confirm("‡§Ø‡•ã ‡§ñ‡§∞‡•ç‡§ö ‡§π‡§ü‡§æ‡§â‡§®‡•á?"))return;
  data[type].splice(i,1);save();
}

/* ======================
   RENDER
====================== */
function render(){
  renderList("current",currentList);
  renderList("fixed",fixedList);
  renderSummary();
}

function renderList(type,wrap){
  wrap.innerHTML="";
  data[type].forEach((e,i)=>{
    const amt=(+e.qty||0)*(+e.rate||0);
    wrap.innerHTML+=`
      <div class="block">
        <label>‡§ñ‡§∞‡•ç‡§ö ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</label>
        <input ${e.edit?"":"readonly"} value="${e.title}"
          oninput="data.${type}[${i}].title=this.value"
          onblur="save()">

        <label>‡§á‡§ï‡§æ‡§à</label>
        <input ${e.edit?"":"readonly"} value="${e.unit}"
          oninput="data.${type}[${i}].unit=this.value"
          onblur="save()">

        <label>‡§™‡§∞‡§ø‡§Æ‡§æ‡§£</label>
        <input type="number" ${e.edit?"":"readonly"} value="${e.qty}"
          oninput="data.${type}[${i}].qty=this.value"
          onblur="save()">

        <label>‡§¶‡§∞</label>
        <input type="number" ${e.edit?"":"readonly"} value="${e.rate}"
          oninput="data.${type}[${i}].rate=this.value"
          onblur="save()">

        <div class="small">‡§ï‡•Å‡§≤: ‡§∞‡•Å ${amt.toLocaleString()}</div>

        ${e.edit?`
          <button class="btn primary" onclick="saveRow('${type}',${i})">üíæ Save</button>
          <button class="btn" onclick="cancel('${type}',${i})">‚Ü©Ô∏è Cancel</button>
        `:`<button class="btn primary" onclick="edit('${type}',${i})">‚úèÔ∏è ‡§∏‡§ö‡•ç‡§Ø‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>`}
        <button class="btn danger" onclick="del('${type}',${i})">üóëÔ∏è ‡§π‡§ü‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
      </div>`;
  });
}

/* ======================
   SUMMARY
====================== */
function renderSummary(){
  const all=[...data.current,...data.fixed];
  if(all.length===0){
    summary.innerHTML="<div class='small'>‡§ñ‡§∞‡•ç‡§ö ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§õ‡•à‡§®‡•§</div>";return;
  }
  let total=0,groups={};
  all.forEach(e=>{
    const amt=(+e.qty||0)*(+e.rate||0);
    total+=amt;
    const t=e.title||"‡§Ö‡§®‡•ç‡§Ø";
    if(!groups[t])groups[t]=0;
    groups[t]+=amt;
  });

  summary.innerHTML=`
    <div class="small">‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö: ‡§∞‡•Å ${total.toLocaleString()}</div>
    <table>
      <tr><th>‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th><th>‡§∞‡§ï‡§Æ</th><th>% ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ</th></tr>
      ${Object.keys(groups).map(t=>{
        const pct=((groups[t]/total)*100).toFixed(2);
        return `<tr><td>${t}</td><td>${groups[t].toLocaleString()}</td><td>${pct}%</td></tr>`;
      }).join("")}
    </table>`;
}

render();
</script>

</body>
</html>
