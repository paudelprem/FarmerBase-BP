<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Expenses ‚Äì FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:system-ui;background:#f5f7fa}
.container{max-width:1000px;margin:auto;padding:16px}
.card{background:#fff;padding:16px;border-radius:8px;margin-bottom:12px}
h2,h3{margin:0 0 8px;color:#1b5e20}
.row{display:flex;gap:8px;flex-wrap:wrap}
input,select,textarea{
  padding:8px;border:1px solid #ccc;border-radius:6px
}
button{
  padding:8px 12px;border:none;border-radius:6px;
  background:#1b5e20;color:#fff;cursor:pointer
}
button.secondary{background:#607d8b}
button.ghost{background:#e8f5e9;color:#1b5e20}

.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border:1px solid #ddd;padding:8px;text-align:right}
.table th{text-align:left;background:#e8f5e9}

.section{border:1px solid #ddd;border-radius:8px;margin-top:10px}
.section-head{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px;background:#f1f8f4
}
.section-body{display:none;padding:10px}
.section-body.open{display:block}

/* ===== GLOBAL NAV ===== */
.g-header{
  display:flex;align-items:center;gap:10px;
  padding:10px;background:#1b5e20;color:#fff
}
.g-header button{background:none;border:none;color:#fff;font-size:18px}
.g-title{flex:1;text-align:center}

.g-footer{
  display:flex;justify-content:space-between;
  padding:10px;border-top:1px solid #ccc
}
.g-footer button{border-radius:20px}
.g-header button:disabled,.g-footer button:disabled{
  opacity:.4;cursor:not-allowed
}
</style>
</head>

<body>

<!-- ===== GLOBAL HEADER ===== -->
<header class="g-header">
  <button id="prevTop" onclick="goPrev()">‚¨ÖÔ∏è</button>
  <div class="g-title">
    <div id="bizHdr"></div>
    <small id="projHdr"></small>
  </div>
  <button id="nextTop" onclick="goNext()">‚û°Ô∏è</button>
</header>

<div class="container">

<div class="card">
  <h2>‡§ñ‡§∞‡•ç‡§ö ‡§µ‡§ø‡§µ‡§∞‡§£ (Expenses)</h2>
  <small>‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§ñ‡§∞‡•ç‡§ö ‡§ï‡•Å‡§® ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡§Æ‡§æ ‡§≤‡§æ‡§ó‡•ç‡§õ ‡§≠‡§®‡•á‡§∞ ‡§õ‡§æ‡§®‡•ç‡§® ‡§∏‡§ï‡§ø‡§®‡•ç‡§õ‡•§</small>
</div>

<!-- ================= RUNNING ================= -->
<div class="card">
  <h3>‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö</h3>
  <div class="row">
    <input id="newRunSec" placeholder="‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï (‡§ú‡§∏‡•ç‡§§‡•à: ‡§¶‡§æ‡§®‡§æ)">
    <button onclick="addSection('run')">‚ûï ‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
  </div>
  <div id="runSecs"></div>
</div>

<!-- ================= FIXED ================= -->
<div class="card">
  <h3>‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö (‡§π‡•ç‡§∞‡§æ‡§∏‡§ï‡§ü‡•ç‡§ü‡•Ä ‡§∏‡§π‡§ø‡§§)</h3>
  <div class="row">
    <input id="newFixSec" placeholder="‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï (‡§ú‡§∏‡•ç‡§§‡•à: ‡§≠‡§µ‡§®)">
    <button onclick="addSection('fix')">‚ûï ‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
  </div>
  <div id="fixSecs"></div>
</div>

</div>

<!-- ===== GLOBAL FOOTER ===== -->
<footer class="g-footer">
  <button id="prevBottom" class="secondary" onclick="goPrev()">‚¨ÖÔ∏è ‡§Ö‡§ò‡§ø‡§≤‡•ç‡§≤‡•ã</button>
  <button id="nextBottom" onclick="goNext()">‡§Ö‡§∞‡•ç‡§ï‡•ã ‚û°Ô∏è</button>
</footer>

<script>
/* ================= GLOBAL NAV ================= */
const flow=[
"index.html","short-info.html","existing-status.html",
"business-detail.html","production.html","expenses.html",
"capital-source.html","income.html","profit-loss.html",
"executive-summary.html","cover.html"
];
const cur=location.pathname.split("/").pop();
const idx=flow.indexOf(cur);
function goPrev(){ if(idx>0) location.href=flow[idx-1]; }
function goNext(){ if(idx<flow.length-1) location.href=flow[idx+1]; }
if(idx<=0){prevTop.disabled=prevBottom.disabled=true;}
if(idx>=flow.length-1){nextTop.disabled=nextBottom.disabled=true;}

/* ================= HEADER META ================= */
const meta=JSON.parse(localStorage.getItem("fb_meta")||"{}");
bizHdr.textContent=meta.business||"‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø";
projHdr.textContent=meta.project||"‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ";

/* ================= PRODUCTION (for mapping) ================= */
const prod=JSON.parse(localStorage.getItem("fb_production")||"[]");
const prodNames=[];
prod.forEach(t=>t.products.forEach(p=>prodNames.push(p.name)));

/* ================= DATA (FIXED) ================= */
const KEY="fb_expenses";
let data = JSON.parse(localStorage.getItem(KEY)) || { run: [], fix: [] };
const save=()=>localStorage.setItem(KEY,JSON.stringify(data));

/* ================= SECTION CRUD ================= */
function addSection(kind){
  const inp = kind==="run"?newRunSec:newFixSec;
  if(!inp.value) return alert("‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§ö‡§æ‡§π‡§ø‡§®‡•ç‡§õ");
  data[kind].unshift({name:inp.value, items:[], narration:""});
  inp.value="";
  save(); render();
}

function delSection(kind,si){
  if(!confirm("‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§π‡§ü‡§æ‡§â‡§®‡•á?")) return;
  data[kind].splice(si,1);
  save(); render();
}

function toggleBody(id){
  document.getElementById(id).classList.toggle("open");
}

/* ================= ITEM ADD ================= */
function addItem(kind,si){
  const box=document.getElementById(add-${kind}-${si});
  const it={
    name:box.querySelector(".i-name").value,
    unit:box.querySelector(".i-unit").value,
    qty:+box.querySelector(".i-qty").value||0,
    rate:+box.querySelector(".i-rate").value||0,
    map:box.querySelector(".i-map").value
  };
  if(!it.name||!it.unit) return alert("‡§®‡§æ‡§Æ ‡§∞ ‡§á‡§ï‡§æ‡§à ‡§ö‡§æ‡§π‡§ø‡§®‡•ç‡§õ");
  data[kind][si].items.unshift(it);   // newest on top
  box.querySelectorAll("input").forEach(i=>i.value="");
  save(); render();
}

/* ================= RENDER ================= */
function render(){
  ["run","fix"].forEach(kind=>{
    const wrap = kind==="run"?runSecs:fixSecs;
    wrap.innerHTML="";
    data[kind].forEach((s,si)=>{
      const sid=`${kind}-${si}`;
      const sec=document.createElement("div");
      sec.className="section";
      sec.innerHTML=`
        <div class="section-head">
          <b>${s.name}</b>
          <div>
            <button class="ghost" onclick="toggleBody('b-${sid}')">‚§µÔ∏è</button>
            <button class="ghost" onclick="delSection('${kind}',${si})">üóëÔ∏è</button>
          </div>
        </div>
        <div class="section-body" id="b-${sid}">
          <div class="row" id="add-${sid}">
            <input class="i-name" placeholder="‡§ï‡•á ‡§∏‡§æ‡§Æ‡§æ‡§®/‡§∏‡•á‡§µ‡§æ">
            <input class="i-unit" placeholder="‡§á‡§ï‡§æ‡§à">
            <input class="i-qty" type="number" placeholder="‡§™‡§∞‡§ø‡§Æ‡§æ‡§£">
            <input class="i-rate" type="number" placeholder="‡§¶‡§∞">
            <select class="i-map">
              <option value="ALL">‡§∏‡§¨‡•à ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®</option>
              ${prodNames.map(p=>`<option>${p}</option>`).join("")}
            </select>
            <button onclick="addItem('${kind}',${si})">‚ûï</button>
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>‡§µ‡§ø‡§µ‡§∞‡§£</th><th>‡§á‡§ï‡§æ‡§à</th><th>‡§™‡§∞‡§ø‡§Æ‡§æ‡§£</th>
                <th>‡§¶‡§∞</th><th>‡§ï‡•Å‡§≤</th><th>‡§≤‡§æ‡§ó‡•ç‡§®‡•á ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®</th>
              </tr>
            </thead>
            <tbody>
              ${s.items.map(i=>`
                <tr>
                  <td style="text-align:left">${i.name}</td>
                  <td style="text-align:left">${i.unit}</td>
                  <td>${i.qty}</td>
                  <td>${i.rate}</td>
                  <td>${(i.qty*i.rate).toFixed(2)}</td>
                  <td style="text-align:left">${i.map}</td>
                </tr>`).join("")}
            </tbody>
          </table>

          <textarea rows="2" placeholder="Narration (‡§∏‡§Æ‡§ó‡•ç‡§∞)"
            oninput="s.narration=this.value">${s.narration||""}</textarea>
        </div>`;
      wrap.appendChild(sec);
    });
  });
}
render();
</script>

</body>
</html>
