<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Expenses | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:system-ui;background:#f5f7fa}
header{
  background:#1b5e20;color:#fff;
  padding:10px 16px;
  display:flex;justify-content:space-between;align-items:center
}
header .right{display:flex;align-items:center;gap:8px}
header button{
  background:transparent;border:1px solid #c8e6c9;
  color:#fff;border-radius:4px;padding:2px 6px;cursor:pointer
}
footer{
  position:fixed;bottom:0;left:0;right:0;
  background:#f1f8f4;border-top:1px solid #ccc;
  padding:8px 12px;
  display:flex;justify-content:space-between
}
.container{
  max-width:1200px;margin:auto;
  padding:16px;padding-bottom:90px
}
.card{
  background:#fff;padding:16px;
  border-radius:8px;margin-bottom:16px
}
h2{margin:0 0 8px;color:#1b5e20}
input,textarea{
  padding:8px;border:1px solid #ccc;border-radius:6px
}
button{
  padding:6px 14px;border:none;border-radius:6px;
  background:#1b5e20;color:#fff;cursor:pointer
}
button.ghost{background:#e8f5e9;color:#1b5e20}
button.danger{background:#c62828}
.section{
  border:1px solid #ddd;border-radius:6px;
  padding:12px;margin-top:10px
}
.section-head{
  display:flex;justify-content:space-between;align-items:center
}
.item{
  display:grid;
  grid-template-columns:2fr 1fr 1fr 1fr 2fr auto;
  gap:6px;align-items:center;
  border-bottom:1px dashed #ddd;padding:6px 0
}
.summary{
  background:#fafafa;padding:12px;border-radius:6px;font-size:14px
}
small{color:#555}
</style>
</head>

<body>

<header>
  <div><b>FarmerBase BP Engine</b></div>
  <div class="right">
    <span id="hdrName"></span>
    <button onclick="location.href='login.html'">‚úèÔ∏è</button>
  </div>
</header>

<div class="container">

  <div class="card summary" id="summaryBox"></div>

  <!-- RUNNING EXPENSE -->
  <div class="card">
    <h2>üîÅ ‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö</h2>
    <input id="runInput" placeholder="‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï (‡§ú‡§∏‡•ç‡§§‡•à: ‡§¶‡§æ‡§®‡§æ)">
    <button onclick="addSection('run')">‚ûï ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
    <div id="runList"></div>
  </div>

  <!-- FIXED EXPENSE -->
  <div class="card">
    <h2>üèóÔ∏è ‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö</h2>
    <input id="fixInput" placeholder="‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï (‡§ú‡§∏‡•ç‡§§‡•à: ‡§ó‡•ã‡§† ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£)">
    <button onclick="addSection('fix')">‚ûï ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
    <div id="fixList"></div>
  </div>

  <!-- NARRATION -->
  <div class="card">
    <h2>üßæ ‡§ñ‡§∞‡•ç‡§ö‡§ï‡•ã ‡§∏‡§Æ‡§ó‡•ç‡§∞ ‡§µ‡§ø‡§µ‡§∞‡§£ (Narration)</h2>
    <textarea id="narration" rows="4"
      placeholder="‡§∏‡§Æ‡§ó‡•ç‡§∞ ‡§ñ‡§∞‡•ç‡§ö ‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ‡§ï‡•ã ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ..."></textarea><br><br>
    <button class="ghost" onclick="autoNarrate()">Auto Draft</button>
    <button onclick="saveNarration()">üíæ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§</button>
  </div>

</div>

<footer>
  <button onclick="location.href='production.html'">‚¨ÖÔ∏è</button>
  <button onclick="location.href='capital-source.html'">‚û°Ô∏è</button>
</footer>

<script>
/* ========= Identity ========= */
const idRaw = localStorage.getItem("fb_identity");
if(idRaw){
  const id = JSON.parse(idRaw);
  hdrName.textContent = id.projectName || id.businessName || "";
}

/* ========= Products (from production) ========= */
const prod = JSON.parse(localStorage.getItem("fb_production") || "[]");
const PRODUCTS = [];
prod.forEach(c => (c.products||[]).forEach(p=>{
  if(p.name) PRODUCTS.push(p.name);
}));

/* ========= Data ========= */
const KEY="fb_expenses_final";
let data = JSON.parse(localStorage.getItem(KEY)) || { run:[], fix:[] };
const save = ()=>localStorage.setItem(KEY, JSON.stringify(data));

/* ========= Render debounce (PERF FIX) ========= */
let raf=null;
function safeRender(){
  if(raf) cancelAnimationFrame(raf);
  raf=requestAnimationFrame(render);
}

/* ========= Add Section ========= */
function addSection(type){
  const inp = document.getElementById(type==="run"?"runInput":"fixInput");
  const v = inp.value.trim();
  if(!v) return alert("‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç");
  data[type].push({ name:v, items:[] });
  inp.value="";
  save(); safeRender();
}

/* ========= Section ops ========= */
function editSection(type,i){
  const n = prompt("‡§®‡§Ø‡§æ‡§Å ‡§®‡§æ‡§Æ:", data[type][i].name);
  if(n){ data[type][i].name=n; save(); safeRender(); }
}
function delSection(type,i){
  if(confirm("‡§π‡§ü‡§æ‡§â‡§®‡•á?")){
    data[type].splice(i,1); save(); safeRender();
  }
}

/* ========= Item ops ========= */
function addItem(type,si){
  const box=document.getElementById(type+"-add-"+si);
  const it={
    name:box.querySelector(".i-name").value.trim(),
    unit:box.querySelector(".i-unit").value.trim(),
    qty:+box.querySelector(".i-qty").value||0,
    rate:+box.querySelector(".i-rate").value||0,
    appliesTo:[...box.querySelectorAll(".map:checked")].map(c=>c.value)
  };
  if(!it.name||!it.unit) return alert("‡§®‡§æ‡§Æ ‡§∞ ‡§á‡§ï‡§æ‡§à ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø");
  if(!it.appliesTo.length) it.appliesTo=["ALL"];
  data[type][si].items.unshift(it);
  box.querySelectorAll("input").forEach(i=>{
    if(i.type!=="checkbox") i.value="";
  });
  save(); safeRender();
}
function editItem(type,si,ii){
  const it=data[type][si].items[ii];
  it.name=prompt("‡§®‡§æ‡§Æ:",it.name)||it.name;
  it.unit=prompt("‡§á‡§ï‡§æ‡§à:",it.unit)||it.unit;
  it.qty=+prompt("‡§™‡§∞‡§ø‡§Æ‡§æ‡§£:",it.qty)||it.qty;
  it.rate=+prompt("‡§¶‡§∞:",it.rate)||it.rate;
  save(); safeRender();
}
function delItem(type,si,ii){
  if(confirm("‡§π‡§ü‡§æ‡§â‡§®‡•á?")){
    data[type][si].items.splice(ii,1); save(); safeRender();
  }
}

/* ========= Calculation ========= */
function calc(){
  let r=0,f=0;
  data.run.forEach(s=>s.items.forEach(i=>r+=i.qty*i.rate));
  data.fix.forEach(s=>s.items.forEach(i=>f+=i.qty*i.rate));
  return { run:r, fix:f, total:r+f };
}

/* ========= Narration ========= */
function autoNarrate(){
  const c=calc();
  narration.value=
    `‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö ${c.total.toFixed(2)} ‡§õ‡•§ `+
    `‡§ú‡§∏‡§Æ‡§ß‡•ç‡§Ø‡•á ${(c.run/c.total*100||0).toFixed(1)}% ‡§ö‡§æ‡§≤‡•Å ‡§∞ `+
    `${(c.fix/c.total*100||0).toFixed(1)}% ‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö ‡§π‡•ã‡•§`;
}
function saveNarration(){
  const c=calc();
  localStorage.setItem(
    "fb_expense_summary",
    JSON.stringify({ ...c, narration:narration.value })
  );
  alert("‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§≠‡§Ø‡•ã");
}

/* ========= Render ========= */
function render(){
  const c=calc();

  /* --- AUTO SYNC FOR CAPITAL SOURCE (CRITICAL FIX) --- */
  localStorage.setItem(
    "fb_expense_summary",
    JSON.stringify({ run:c.run, fix:c.fix, total:c.total })
  );

  summaryBox.innerHTML =
    `<b>‡§ï‡•Å‡§≤:</b> ${c.total.toFixed(2)} |
     ‡§ö‡§æ‡§≤‡•Å ${c.run.toFixed(2)} (${(c.run/c.total*100||0).toFixed(1)}%) |
     ‡§∏‡•ç‡§•‡§ø‡§∞ ${c.fix.toFixed(2)} (${(c.fix/c.total*100||0).toFixed(1)}%)`;

  [["run","runList"],["fix","fixList"]].forEach(([type,wrapId])=>{
    const wrap=document.getElementById(wrapId);
    wrap.innerHTML="";
    data[type].forEach((s,si)=>{
      const d=document.createElement("div");
      d.className="section";
      d.innerHTML=`
        <div class="section-head">
          <b>${s.name}</b>
          <div>
            <button class="ghost" onclick="editSection('${type}',${si})">‚úèÔ∏è</button>
            <button class="danger" onclick="delSection('${type}',${si})">‚úñ</button>
          </div>
        </div>

        <div class="item" id="${type}-add-${si}">
          <input class="i-name" placeholder="‡§ñ‡§∞‡•ç‡§ö ‡§®‡§æ‡§Æ">
          <input class="i-unit" placeholder="‡§á‡§ï‡§æ‡§à">
          <input class="i-qty" type="number" placeholder="‡§™‡§∞‡§ø‡§Æ‡§æ‡§£">
          <input class="i-rate" type="number" placeholder="‡§¶‡§∞">
          <div>
            <label><input type="checkbox" class="map" value="ALL" checked> ‡§∏‡§¨‡•à</label><br>
            ${PRODUCTS.map(p=>`
              <label>
                <input type="checkbox" class="map" value="${p}"> ${p}
              </label>`).join("")}
          </div>
          <button onclick="addItem('${type}',${si})">‚ûï</button>
        </div>

        ${s.items.map((it,ii)=>`
          <div class="item">
            <span>${it.name}</span>
            <span>${it.unit}</span>
            <span>${it.qty}</span>
            <span>${it.rate}</span>
            <small>${it.appliesTo.join(", ")}</small>
            <div>
              <button class="ghost" onclick="editItem('${type}',${si},${ii})">‚úèÔ∏è</button>
              <button class="danger" onclick="delItem('${type}',${si},${ii})">‚úñ</button>
            </div>
          </div>`).join("")}
      `;
      wrap.appendChild(d);
    });
  });
}

safeRender();
</script>
</body>
</html>
