<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Expenses ‚Äì FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:system-ui;background:#f5f7fa}
.container{max-width:1100px;margin:auto;padding:16px}
.card{background:#fff;padding:16px;border-radius:8px;margin-bottom:16px}
h2{margin:0 0 12px;color:#1b5e20}

.row{display:flex;gap:8px;flex-wrap:wrap}
input,textarea{
  padding:8px;border:1px solid #ccc;border-radius:6px
}
button{
  padding:8px 14px;border:none;border-radius:6px;
  background:#1b5e20;color:#fff;cursor:pointer
}
button.ghost{background:#e8f5e9;color:#1b5e20}
button.danger{background:#c62828}

.section{
  border:1px solid #ddd;border-radius:6px;
  padding:10px;margin-top:10px
}
.section-head{
  display:flex;justify-content:space-between;align-items:center
}
.items{margin-top:8px}
.item{
  display:grid;
  grid-template-columns:2fr 1fr 1fr 1fr 2fr auto;
  gap:6px;align-items:center;
  border-bottom:1px dashed #ddd;padding:6px 0
}
.small{font-size:12px;color:#666}
</style>
</head>

<body>
<div class="container">

<!-- ===== SUMMARY ===== -->
<div class="card">
  <h2>‡§ñ‡§∞‡•ç‡§ö ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</h2>
  <div id="summaryText" class="small"></div>
</div>

<!-- ===== RUNNING COST (LOCKED TITLE) ===== -->
<div class="card">
  <h2>‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö</h2>
  <div class="row">
    <input id="runInput" placeholder="‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï (‡§ú‡§∏‡•ç‡§§‡•à: ‡§¶‡§æ‡§®‡§æ)">
    <button type="button" onclick="addSection('run')">‚ûï ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
  </div>
  <div id="runList"></div>
</div>

<!-- ===== FIXED COST (LOCKED TITLE) ===== -->
<div class="card">
  <h2>‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö</h2>
  <div class="row">
    <input id="fixInput" placeholder="‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï (‡§ú‡§∏‡•ç‡§§‡•à: ‡§≠‡§µ‡§®)">
    <button type="button" onclick="addSection('fix')">‚ûï ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
  </div>
  <div id="fixList"></div>
</div>

<!-- ===== NARRATION ===== -->
<div class="card">
  <h2>‡§∏‡§Æ‡§ó‡•ç‡§∞ ‡§ñ‡§∞‡•ç‡§ö ‡§µ‡§ø‡§µ‡§∞‡§£</h2>
  <textarea id="narration" rows="4"
    placeholder="‡§Ø‡§π‡§æ‡§Å ‡§∏‡§Æ‡§ó‡•ç‡§∞ ‡§ñ‡§∞‡•ç‡§ö‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç..."></textarea>
  <div class="row" style="margin-top:8px">
    <button type="button" class="ghost" onclick="autoNarrate()">Auto-draft</button>
    <button type="button" onclick="saveSummary()">üíæ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§</button>
  </div>
</div>

</div>

<script>
/* ================= PRODUCTION ================= */
const prodRaw = JSON.parse(localStorage.getItem("fb_production") || "[]");
const PRODUCTS = [];
prodRaw.forEach(t => (t.products||[]).forEach(p => p.name && PRODUCTS.push(p.name)));

/* ================= DATA ================= */
const KEY = "fb_expenses_final";
let data = JSON.parse(localStorage.getItem(KEY)) || { run: [], fix: [] };
const save = () => localStorage.setItem(KEY, JSON.stringify(data));

/* ================= SECTION ================= */
function addSection(type){
  const inp = document.getElementById(type==="run" ? "runInput" : "fixInput");
  if(!inp.value){ alert("‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç"); return; }
  data[type].push({ name: inp.value, items: [] });
  inp.value="";
  save(); render();
}
function editSection(type,i){
  const n = prompt("‡§®‡§Ø‡§æ‡§Å ‡§®‡§æ‡§Æ:", data[type][i].name);
  if(n){ data[type][i].name=n; save(); render(); }
}
function delSection(type,i){
  if(!confirm("‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§π‡§ü‡§æ‡§â‡§®‡•á?")) return;
  data[type].splice(i,1); save(); render();
}

/* ================= ITEM ================= */
function addItem(type,si){
  const box = document.getElementById(${type}-item-${si});
  const applies = [...box.querySelectorAll(".map:checked")].map(c=>c.value);
  const it = {
    name: box.querySelector(".i-name").value,
    unit: box.querySelector(".i-unit").value,
    qty: +box.querySelector(".i-qty").value || 0,
    rate:+box.querySelector(".i-rate").value || 0,
    appliesTo: applies.length ? applies : ["ALL"]
  };
  if(!it.name || !it.unit){
    alert("‡§®‡§æ‡§Æ ‡§∞ ‡§á‡§ï‡§æ‡§à ‡§ö‡§æ‡§π‡§ø‡§®‡•ç‡§õ"); return;
  }
  data[type][si].items.unshift(it);
  box.querySelectorAll("input").forEach(i=>{
    if(i.type!=="checkbox") i.value="";
  });
  save(); render();
}
function editItem(type,si,ii){
  const it = data[type][si].items[ii];
  const n = prompt("‡§ñ‡§∞‡•ç‡§ö ‡§®‡§æ‡§Æ:", it.name); if(!n) return;
  it.unit = prompt("‡§á‡§ï‡§æ‡§à:", it.unit) || it.unit;
  it.qty  = +prompt("‡§™‡§∞‡§ø‡§Æ‡§æ‡§£:", it.qty) || it.qty;
  it.rate = +prompt("‡§¶‡§∞:", it.rate) || it.rate;
  it.name = n;
  save(); render();
}
function delItem(type,si,ii){
  if(!confirm("‡§π‡§ü‡§æ‡§â‡§®‡•á?")) return;
  data[type][si].items.splice(ii,1);
  save(); render();
}

/* ================= CALC ================= */
function calc(){
  let run=0, fix=0;
  data.run.forEach(s=>s.items.forEach(i=>run+=i.qty*i.rate));
  data.fix.forEach(s=>s.items.forEach(i=>fix+=i.qty*i.rate));
  const t = run + fix;
  return {t, run, fix};
}

/* ================= SUMMARY ================= */
function renderSummary(){
  const c = calc();
  summaryText.textContent =
    ‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö ${c.t.toFixed(2)} | ‡§ö‡§æ‡§≤‡•Å ${(c.run/c.t*100||0).toFixed(1)}% | ‡§∏‡•ç‡§•‡§ø‡§∞ ${(c.fix/c.t*100||0).toFixed(1)}%;
}

/* ================= NARRATION ================= */
function autoNarrate(){
  const c = calc();
  narration.value =
    ‡§Ø‡§∏ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø‡§ï‡•ã ‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö ${c.t.toFixed(2)} ‡§∞‡§π‡•á‡§ï‡•ã ‡§õ‡•§  +
    ‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö ${(c.run/c.t*100||0).toFixed(1)}% ‡§∞  +
    ‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö ${(c.fix/c.t*100||0).toFixed(1)}% ‡§∞‡§π‡•á‡§ï‡•ã ‡§õ‡•§;
}
function saveSummary(){
  localStorage.setItem("fb_expense_summary",
    JSON.stringify({ ...calc(), narration: narration.value })
  );
  alert("‡§ñ‡§∞‡•ç‡§ö ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§≠‡§Ø‡•ã");
}

/* ================= RENDER ================= */
function render(){
  ["run","fix"].forEach(type=>{
    const wrap = document.getElementById(type+"List");
    wrap.innerHTML="";
    data[type].forEach((s,si)=>{
      const d = document.createElement("div");
      d.className="section";
      d.innerHTML=`
        <div class="section-head">
          <b>${s.name}</b>
          <div>
            <button type="button" class="ghost" onclick="editSection('${type}',${si})">‚úèÔ∏è</button>
            <button type="button" class="danger" onclick="delSection('${type}',${si})">‚úñ</button>
          </div>
        </div>

        <div class="items">
          <div class="item" id="${type}-item-${si}">
            <input class="i-name" placeholder="‡§®‡§æ‡§Æ">
            <input class="i-unit" placeholder="‡§á‡§ï‡§æ‡§à">
            <input class="i-qty" type="number" placeholder="‡§™‡§∞‡§ø‡§Æ‡§æ‡§£">
            <input class="i-rate" type="number" placeholder="‡§¶‡§∞">
            <div>
              <label><input type="checkbox" class="map" value="ALL" checked> ‡§∏‡§¨‡•à</label><br>
              ${PRODUCTS.map(p=>`
                <label><input type="checkbox" class="map" value="${p}"> ${p}</label>
              `).join("")}
            </div>
            <button type="button" onclick="addItem('${type}',${si})">‚ûï</button>
          </div>

          ${s.items.map((it,ii)=>`
            <div class="item">
              <span>${it.name}</span>
              <span>${it.unit}</span>
              <span>${it.qty}</span>
              <span>${it.rate}</span>
              <small>${it.appliesTo.join(", ")}</small>
              <div>
                <button type="button" class="ghost"
                  onclick="editItem('${type}',${si},${ii})">‚úèÔ∏è</button>
                <button type="button" class="danger"
                  onclick="delItem('${type}',${si},${ii})">‚úñ</button>
              </div>
            </div>
          `).join("")}
        </div>
      `;
      wrap.appendChild(d);
    });
  });
  renderSummary();
}
render();
</script>
</body>
</html>
