<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§∏‡•ç‡§•‡§ø‡§§‡§ø | FarmerBase BP Engine</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#f6f7f9;color:#222}
:root{--w:980px;--g:#1b5e20;--b:#ddd}

/* ===== NAVIGATION (MANDATORY) ===== */
.nav-bar{
  max-width:var(--w);
  margin:8px auto;
  padding:8px 14px;
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.nav-btn{
  text-decoration:none;
  font-size:13px;
  padding:6px 14px;
  border-radius:20px;
  border:1px solid #ccc;
  background:#fafafa;
  color:#222;
}
.nav-btn.primary{
  background:var(--g);
  color:#fff;
  border-color:var(--g);
}
.top-nav{position:sticky;top:0;background:#f6f7f9;z-index:9}
.bottom-nav{position:sticky;bottom:0;background:#f6f7f9;z-index:9}

/* ===== LAYOUT ===== */
.main{max-width:var(--w);margin:10px auto 20px;padding:0 14px}
.card{background:#fff;border:1px solid var(--b);border-radius:8px;margin-bottom:16px}
.card h3{
  margin:0;padding:10px 12px;
  background:#f3f5f7;border-bottom:1px solid var(--b);font-size:14px
}
.card .body{padding:12px;font-size:13px}

.btn{
  margin:6px 4px 6px 0;
  padding:6px 10px;
  border:1px solid #ccc;
  border-radius:6px;
  background:#fafafa;
  cursor:pointer;
}
.btn.primary{background:var(--g);color:#fff;border-color:var(--g)}
.btn.danger{background:#fdecea;border-color:#e53935;color:#b71c1c}
.small{font-size:12px}

input,textarea{
  width:100%;
  padding:6px;
  margin:4px 0;
  border:1px solid #ccc;
  border-radius:6px;
  font-size:13px;
}
textarea{resize:vertical}

/* ===== CONTENT BLOCKS ===== */
.topic-box{border-left:3px solid var(--g);padding-left:10px;margin-top:14px}
.bullet{display:flex;gap:6px;margin:4px 0}
.check-q{margin-top:10px;padding:8px;border-left:3px solid #1b5e20}
.opt{display:flex;gap:6px;margin:4px 0}
.opt-text{flex:1}
</style>
</head>

<body>

<!-- üîº TOP NAV (always visible when user is at top) -->
<div class="nav-bar top-nav">
  <a href="short-info.html" class="nav-btn">‚¨ÖÔ∏è ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</a>
  <a href="production.html" class="nav-btn primary">‚û°Ô∏è ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£</a>
</div>

<div class="main">

<!-- BUSINESS HEADER -->
<div class="card">
  <h3 id="bizTitle">‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø</h3>
  <div class="body" id="bizMeta"></div>
</div>

<!-- TOPIC / CONTENT / CHECKLIST -->
<div class="card">
  <h3>üß† ‡§µ‡§ø‡§∑‡§Ø / ‡§µ‡§ø‡§µ‡§∞‡§£ / ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‚Äì‡§â‡§§‡•ç‡§§‡§∞</h3>
  <div class="body">
    <button class="btn primary" onclick="addTopic()">‚ûï ‡§®‡§Ø‡§æ‡§Å Topic ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
    <div id="topicList"></div>
  </div>
</div>

</div>

<!-- üîΩ BOTTOM NAV (always visible when user is at bottom) -->
<div class="nav-bar bottom-nav">
  <a href="short-info.html" class="nav-btn">‚¨ÖÔ∏è ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</a>
  <a href="production.html" class="nav-btn primary">‚û°Ô∏è ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£</a>
</div>

<script>
/* ======================
   BUSINESS LOAD
====================== */
const B = JSON.parse(localStorage.getItem("fb_businesses")||"{}");
const BID = B.activeId;
const INFO = JSON.parse(localStorage.getItem("fb_business_info_"+BID)||"{}");

document.getElementById("bizTitle").textContent =
  INFO.name || "‡§®‡§æ‡§Æ ‡§®‡§≠‡§è‡§ï‡•ã ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø";
document.getElementById("bizMeta").textContent =
  `‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ: ${INFO.pref?.cur||"NPR"} | ‡§≠‡§æ‡§∑‡§æ: ${INFO.pref?.lang||"np"}`;

/* ======================
   DATA STORE
====================== */
const KEY = "fb_topics_" + BID;
let topics = JSON.parse(localStorage.getItem(KEY) || "[]");

function save(){
  localStorage.setItem(KEY, JSON.stringify(topics));
  render();
}

/* ======================
   CRUD FUNCTIONS
====================== */
function addTopic(){
  topics.push({
    id:"t"+Date.now(),
    title:"",
    content:"",
    bullets:[],
    qa:[]
  });
  save();
}

function deleteTopic(id){
  if(!confirm("‡§Ø‡•ã Topic ‡§π‡§ü‡§æ‡§â‡§®‡•á?")) return;
  topics = topics.filter(t=>t.id!==id);
  save();
}

function updateTopic(id,key,val){
  topics.find(t=>t.id===id)[key]=val;
  save();
}

/* Bullets */
function addBullet(id){
  topics.find(t=>t.id===id).bullets.push("");
  save();
}
function updateBullet(id,i,val){
  topics.find(t=>t.id===id).bullets[i]=val;
  save();
}
function deleteBullet(id,i){
  topics.find(t=>t.id===id).bullets.splice(i,1);
  save();
}

/* Checklist */
function addQuestion(id){
  topics.find(t=>t.id===id).qa.push({
    q:"",
    options:[{text:"",checked:false}]
  });
  save();
}
function addOption(id,qi){
  topics.find(t=>t.id===id).qa[qi].options.push({text:"",checked:false});
  save();
}
function updateQ(id,qi,val){
  topics.find(t=>t.id===id).qa[qi].q=val;
  save();
}
function updateOpt(id,qi,oi,val){
  topics.find(t=>t.id===id).qa[qi].options[oi].text=val;
  save();
}
function toggleOpt(id,qi,oi,val){
  topics.find(t=>t.id===id).qa[qi].options[oi].checked=val;
  save();
}

/* ======================
   RENDER (FIXED)
====================== */
function render(){
  const wrap=document.getElementById("topicList");
  wrap.innerHTML="";

  topics.forEach(t=>{
    const box=document.createElement("div");
    box.className="topic-box";

    box.innerHTML=`
      <label>Topic ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</label>
      <input value="${t.title}" oninput="updateTopic('${t.id}','title',this.value)">

      <label>‡§µ‡§ø‡§µ‡§∞‡§£ (Paragraph)</label>
      <textarea rows="4" oninput="updateTopic('${t.id}','content',this.value)">${t.content}</textarea>

      <label>‡§¨‡•Å‡§Å‡§¶‡§æ</label>
      ${t.bullets.map((b,i)=>`
        <div class="bullet">
          <input value="${b}" oninput="updateBullet('${t.id}',${i},this.value)">
          <button class="btn danger small" onclick="deleteBullet('${t.id}',${i})">‚úñ</button>
        </div>
      `).join("")}
      <button class="btn small" onclick="addBullet('${t.id}')">‚ûï ‡§¨‡•Å‡§Å‡§¶‡§æ ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>

      <hr>
      <button class="btn" onclick="addQuestion('${t.id}')">‚ûï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
      <button class="btn danger" onclick="deleteTopic('${t.id}')">üóëÔ∏è Topic ‡§π‡§ü‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
    `;

    t.qa.forEach((q,qi)=>{
      const qd=document.createElement("div");
      qd.className="check-q";
      qd.innerHTML=`
        <label>‚ùì ‡§™‡•ç‡§∞‡§∂‡•ç‡§®</label>
        <input value="${q.q}" oninput="updateQ('${t.id}',${qi},this.value)">
      `;

      q.options.forEach((o,oi)=>{
        qd.innerHTML+=`
          <div class="opt">
            <input type="checkbox" ${o.checked?"checked":""}
              onchange="toggleOpt('${t.id}',${qi},${oi},this.checked)">
            <input class="opt-text" value="${o.text}"
              oninput="updateOpt('${t.id}',${qi},${oi},this.value)">
          </div>
        `;
      });

      qd.innerHTML+=`
        <button class="btn small" onclick="addOption('${t.id}',${qi})">
          ‚ûï ‡§â‡§§‡•ç‡§§‡§∞ ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
        </button>
      `;

      box.appendChild(qd);
    });

    wrap.appendChild(box);
  });
}

render();
</script>

</body>
</html>
