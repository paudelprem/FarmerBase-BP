<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Profit & Loss | FarmerBase BP Engine</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#f6f7f9;color:#222}
:root{--w:980px;--g:#1b5e20;--b:#ddd}

/* HEADER */
.header{position:sticky;top:0;z-index:100;background:#fff;border-bottom:1px solid var(--b)}
.header-inner{max-width:var(--w);margin:auto;padding:10px 14px}
.header h1{margin:0;font-size:16px}
.header .sub{font-size:12px;color:#555}

/* NAV */
.nav-bar{max-width:var(--w);margin:8px auto;padding:0 14px;display:flex;justify-content:space-between}
.nav-btn{text-decoration:none;font-size:13px;padding:6px 14px;border-radius:20px;border:1px solid #ccc;background:#fafafa;color:#222}
.nav-btn.primary{background:var(--g);color:#fff;border-color:var(--g)}
.top-nav{position:sticky;top:56px}
.bottom-nav{position:sticky;bottom:0}

/* MAIN */
.main{max-width:var(--w);margin:10px auto 20px;padding:0 14px}
.card{background:#fff;border:1px solid var(--b);border-radius:8px;margin-bottom:16px}
.card h3{margin:0;padding:10px 12px;background:#f3f5f7;border-bottom:1px solid var(--b);font-size:14px}
.card .body{padding:12px;font-size:13px}

table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:6px;font-size:12px;text-align:right}
th{text-align:center;background:#f3f5f7}
td:first-child,th:first-child{text-align:left}

input{padding:4px;font-size:12px;width:90px}
.btn{font-size:12px;padding:4px 10px;margin:4px;cursor:pointer}
.btn.primary{color:#1b5e20;font-weight:600}
.btn.danger{color:#b71c1c}

.small{font-size:11px;color:#555}
.warn{color:#b71c1c;font-size:12px;margin-top:6px}

@media print{.nav-bar{display:none}}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <h1 id="pageTitle">рдкрд░рд┐рдпреЛрдЬрдирд╛рдХреЛ рдирд╛рдо</h1>
    <div class="sub" id="pageSub">рд╡реНрдпрд╡рд╕рд╛рдп / рд╕рдВрд╕реНрдерд╛рдХреЛ рдирд╛рдо</div>
  </div>
</div>

<div class="nav-bar top-nav">
  <a href="income.html" class="nav-btn">тмЕя╕П рдЖрдореНрджрд╛рдиреА</a>
  <a href="index.html" class="nav-btn primary">ЁЯПа Home</a>
</div>

<div class="main">

<!-- PROFIT LOSS SUMMARY -->
<div class="card">
  <h3>ЁЯУС рд╡рд╛рд░реНрд╖рд┐рдХ рдирд╛рдлрд╛тАУрдиреЛрдХреНрд╕рд╛рди рд╡рд┐рд╡рд░рдг</h3>
  <div class="body" id="plSummary"></div>
</div>

<!-- ROI -->
<div class="card">
  <h3>ЁЯУИ ROI рд░ Payback Period</h3>
  <div class="body" id="roiBox"></div>
</div>

<!-- PROFIT DISTRIBUTION -->
<div class="card">
  <h3>ЁЯФД рд▓рд╛рднрд╛рдВрд╢ / рдирд╛рдлрд╛ рд╡рд┐рддрд░рдг</h3>
  <div class="body">

    <button class="btn primary" id="addDistRow">тЮХ рд╡рд┐рддрд░рдг рд╢реАрд░реНрд╖рдХ рдердкреНрдиреБрд╣реЛрд╕реН</button>

    <table>
      <thead>
        <tr>
          <th>рд╢реАрд░реНрд╖рдХ</th>
          <th>%</th>
          <th>рд░рдХрдо (рд░реБ)</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="distTable"></tbody>
    </table>

    <div id="distWarn" class="warn"></div>
    <div class="small">тД╣я╕П рд╢реБрджреНрдз рдирд╛рдлрд╛рдХреЛ рдкреНрд░рддрд┐рд╢рдд рдЕрдиреБрд╕рд╛рд░ рд╡рд┐рддрд░рдг рд╣реБрдиреНрдЫред</div>
  </div>
</div>

<!-- GROWTH SETTINGS -->
<div class="card">
  <h3>тЪЩя╕П рел рд╡рд░реНрд╖реЗ рдкреНрд░рдХреНрд╖реЗрдкрдг тАУ рдмреГрджреНрдзрд┐ рджрд░</h3>
  <div class="body">
    <label>
      <input type="radio" name="gmode" value="same" checked
        onchange="growth.mode='same';saveGrowth()">
      рд╕рдмреИ рд╡рд░реНрд╖рдорд╛ рдПрдЙрдЯреИ рдмреГрджреНрдзрд┐ рджрд░
    </label>
    <label>
      <input type="radio" name="gmode" value="yearly"
        onchange="growth.mode='yearly';saveGrowth()">
      рд╣рд░реЗрдХ рд╡рд░реНрд╖ рдлрд░рдХ рдмреГрджреНрдзрд┐ рджрд░
    </label>
    <div id="growthInputs" style="margin-top:10px"></div>
  </div>
</div>

<!-- 5 YEAR PROJECTION -->
<div class="card">
  <h3>ЁЯУК рел рд╡рд░реНрд╖реЗ рдЖрдореНрджрд╛рдиреАтАУрдЦрд░реНрдЪ рдкреНрд░рдХреНрд╖реЗрдкрдг</h3>
  <div class="body">
    <table>
      <thead>
        <tr>
          <th>рд╡рд░реНрд╖</th>
          <th>рдЖрдореНрджрд╛рдиреА</th>
          <th>рдЦрд░реНрдЪ</th>
          <th>рдирд╛рдлрд╛</th>
          <th>рд╕рдВрдЪрд┐рдд рдирд╛рдлрд╛</th>
        </tr>
      </thead>
      <tbody id="yearTable"></tbody>
    </table>
  </div>
</div>

</div>

<div class="nav-bar bottom-nav">
  <a href="income.html" class="nav-btn">тмЕя╕П рдЖрдореНрджрд╛рдиреА</a>
  <a href="index.html" class="nav-btn primary">ЁЯПа Home</a>
</div>

<script>
/* ========= IDENTITY ========= */
const B = JSON.parse(localStorage.getItem("fb_businesses")||"{}");
const BID = B.activeId || "b1";
const info = JSON.parse(localStorage.getItem("fb_short_info_"+BID)||"{}");
pageTitle.textContent = info.projectName || "рдкрд░рд┐рдпреЛрдЬрдирд╛рдХреЛ рдирд╛рдо";
pageSub.textContent   = info.businessName || "рд╡реНрдпрд╡рд╕рд╛рдп";

/* ========= EXPENSE ========= */
const exp = JSON.parse(localStorage.getItem("fb_expenses_"+BID)||"{}");
let totalExpense = 0;
[...(exp.current||[]),...(exp.fixed||[])].forEach(e=>{
  totalExpense += (+e.qty||0)*(+e.rate||0);
});

/* ========= CAPITAL (INTEREST) ========= */
const cap = JSON.parse(localStorage.getItem("fb_capital_source_"+BID)||"{}");
let totalInterest = 0;
(cap.rows||[]).forEach(r=>{
  if(r.loan){
    const amt = totalExpense*((+r.pct||0)/100);
    totalInterest += amt*((+r.rate||0)/100);
  }
});

/* ========= INCOME ========= */
const income = JSON.parse(localStorage.getItem("fb_income_"+BID)||"{}");
const prod = JSON.parse(localStorage.getItem("fb_production_items_"+BID)||"[]");

let totalIncome = 0;
prod.forEach(p=>{
  const d = income[p.name] || {};
  totalIncome += (+d.price||0) * (+p.qty||0);
});

/* ========= PROFIT ========= */
const grossProfit = totalIncome - totalExpense;
const netProfit   = grossProfit - totalInterest;

/* ========= ROI & PAYBACK ========= */
const ROI = totalExpense ? (netProfit/totalExpense*100) : 0;
const payback = netProfit>0 ? (totalExpense/netProfit) : 0;

/* ========= SUMMARY ========= */
plSummary.innerHTML = `
<table>
<tr><td>рдХреБрд▓ рдЖрдореНрджрд╛рдиреА</td><td>рд░реБ ${totalIncome.toLocaleString()}</td></tr>
<tr><td>рдХреБрд▓ рдЦрд░реНрдЪ</td><td>рд░реБ ${totalExpense.toLocaleString()}</td></tr>
<tr><td>рдХреБрд▓ рдмреНрдпрд╛рдЬ</td><td>рд░реБ ${totalInterest.toLocaleString()}</td></tr>
<tr><th>рд╢реБрджреНрдз рдирд╛рдлрд╛</th><th>рд░реБ ${netProfit.toLocaleString()}</th></tr>
</table>
`;

roiBox.innerHTML = `
<div>ROI: <b>${ROI.toFixed(2)} %</b></div>
<div>Payback Period: <b>${payback.toFixed(2)} рд╡рд░реНрд╖</b></div>
`;

/* ========= PROFIT DISTRIBUTION ========= */
const DKEY = "fb_profit_distribution_"+BID;
let dist = JSON.parse(localStorage.getItem(DKEY)||"null");
if(!dist){
  dist = [
    {title:"рдкреБрдирдГ рд▓рдЧрд╛рдиреА",pct:50},
    {title:"рд╕рд╛рдореБрджрд╛рдпрд┐рдХ / рд╡рд╛рддрд╛рд╡рд░рдг рд╡рд┐рдХрд╛рд╕",pct:20},
    {title:"рдХрд╛рдорджрд╛рд░ рдХреНрд╖рдорддрд╛ рд╡рд┐рдХрд╛рд╕",pct:10},
    {title:"рдЕрдиреНрдп",pct:20}
  ];
}

function saveDist(){
  localStorage.setItem(DKEY, JSON.stringify(dist));
  renderDist();
}

function renderDist(){
  distTable.innerHTML="";
  let pctSum=0;
  dist.forEach((r,i)=>{
    const amt = netProfit*((+r.pct||0)/100);
    pctSum+=(+r.pct||0);
    distTable.innerHTML+=`
      <tr>
        <td><input value="${r.title}"
          oninput="dist[${i}].title=this.value;saveDist()"></td>
        <td><input type="number" value="${r.pct}"
          oninput="dist[${i}].pct=this.value;saveDist()"></td>
        <td>рд░реБ ${amt.toLocaleString()}</td>
        <td><button class="btn danger"
          onclick="dist.splice(${i},1);saveDist()">ЁЯЧСя╕П</button></td>
      </tr>`;
  });
  distWarn.textContent =
    pctSum===100 ? "" : "тЪая╕П рд╡рд┐рддрд░рдгрдХреЛ рдХреБрд▓ рдкреНрд░рддрд┐рд╢рдд 100% рд╣реБрдиреБрдкрд░реНрдЫ";
}
document.getElementById("addDistRow")
  .addEventListener("click",()=>{
    dist.push({title:"",pct:0});
    saveDist();
  });
renderDist();

/* ========= GROWTH ========= */
const GKEY="fb_growth_"+BID;
let growth=JSON.parse(localStorage.getItem(GKEY)||"null");
if(!growth){
  growth={mode:"same",income:[5,5,5,5,5],expense:[3,3,3,3,3]};
}

function saveGrowth(){
  localStorage.setItem(GKEY,JSON.stringify(growth));
  renderGrowthInputs();renderProjection();
}

function renderGrowthInputs(){
  let html="";
  if(growth.mode==="same"){
    html=`
      <label>рдЖрдореНрджрд╛рдиреА рдмреГрджреНрдзрд┐ %</label>
      <input type="number" value="${growth.income[0]}"
        oninput="growth.income=[this.value,this.value,this.value,this.value,this.value];saveGrowth()">
      <label style="margin-left:10px">рдЦрд░реНрдЪ рдмреГрджреНрдзрд┐ %</label>
      <input type="number" value="${growth.expense[0]}"
        oninput="growth.expense=[this.value,this.value,this.value,this.value,this.value];saveGrowth()">`;
  }else{
    html=`<table><tr><th>рд╡рд░реНрд╖</th><th>рдЖрдореНрджрд╛рдиреА %</th><th>рдЦрд░реНрдЪ %</th></tr>`;
    for(let i=0;i<5;i++){
      html+=`
      <tr>
        <td>рд╡рд░реНрд╖ ${i+1}</td>
        <td><input type="number" value="${growth.income[i]}"
          oninput="growth.income[${i}]=this.value;saveGrowth()"></td>
        <td><input type="number" value="${growth.expense[i]}"
          oninput="growth.expense[${i}]=this.value;saveGrowth()"></td>
      </tr>`;
    }
    html+=`</table>`;
  }
  growthInputs.innerHTML=html;
}

function renderProjection(){
  yearTable.innerHTML="";
  let cum=0,inc=totalIncome,ex=totalExpense;
  for(let y=0;y<5;y++){
    if(y>0){
      inc*=(1+(+growth.income[y]/100));
      ex*=(1+(+growth.expense[y]/100));
    }
    const profit=inc-ex;
    cum+=profit;
    yearTable.innerHTML+=`
      <tr>
        <td>рд╡рд░реНрд╖ ${y+1}</td>
        <td>рд░реБ ${inc.toLocaleString()}</td>
        <td>рд░реБ ${ex.toLocaleString()}</td>
        <td>рд░реБ ${profit.toLocaleString()}</td>
        <td>рд░реБ ${cum.toLocaleString()}</td>
      </tr>`;
  }
}

renderGrowthInputs();
renderProjection();
</script>

</body>
</html>
